<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
<title>The Canvas v3</title>
<link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=Geist+Mono:wght@300;400;500;600&family=Lora:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}

/* ‚îÄ‚îÄ LIGHT MODE (default) ‚îÄ‚îÄ */
:root{
  --bg:#f5f4f0;--bg2:#eeede9;--bg3:#e8e6e1;
  --paper:#fffffe;--paper2:#faf9f7;
  --border:rgba(0,0,0,.08);--border2:rgba(0,0,0,.14);
  --text:#1a1916;--text2:#3d3b35;--muted:#8a8880;
  --faint:rgba(0,0,0,.03);--faint2:rgba(0,0,0,.055);
  --accent:#d4580a;--accent2:#b84a08;--accentbg:rgba(212,88,10,.08);
  --blue:#2563eb;--green:#16a34a;--red:#dc2626;--purple:#7c3aed;--yellow:#ca8a04;
  --canvas-paper:#fffffe;--canvas-grid:rgba(0,0,0,0.055);--canvas-lines:rgba(0,0,0,0.07);
  --canvas-dots:rgba(0,0,0,0.12);--canvas-margin:rgba(212,88,10,0.15);
  --topbar-bg:rgba(245,244,240,.94);--hud-bg:rgba(245,244,240,.85);
  --font-serif:'Instrument Serif',Georgia,serif;
  --font-body:'Lora',Georgia,serif;
  --font-mono:'Geist Mono',monospace;
  --sidebar-w:260px;--topbar-h:52px;
  --tool-w:56px;
  --radius:12px;
  --shadow:0 2px 12px rgba(0,0,0,.08),0 0 1px rgba(0,0,0,.06);
  --shadow-lg:0 8px 32px rgba(0,0,0,.12),0 0 1px rgba(0,0,0,.08);
}

/* ‚îÄ‚îÄ DARK MODE ‚îÄ‚îÄ */
:root.dark{
  --bg:#0d0d0b;--bg2:#111110;--bg3:#161614;
  --paper:#13130f;--paper2:#0f0f0d;
  --border:rgba(255,248,230,.06);--border2:rgba(255,248,230,.11);
  --text:#f0ead8;--text2:#c8bfa8;--muted:rgba(240,234,216,.38);
  --faint:rgba(240,234,216,.04);--faint2:rgba(240,234,216,.07);
  --accent:#e8a87c;--accent2:#c47a45;--accentbg:rgba(232,168,124,.08);
  --blue:#7aafd4;--green:#7fba84;--red:#e07070;--purple:#a78bfa;--yellow:#f5d76e;
  --canvas-paper:#13130f;--canvas-grid:rgba(255,248,230,.04);--canvas-lines:rgba(255,248,230,.06);
  --canvas-dots:rgba(255,248,230,.18);--canvas-margin:rgba(232,168,124,.15);
  --topbar-bg:rgba(13,13,11,.96);--hud-bg:rgba(13,13,11,.88);
  --shadow:0 2px 12px rgba(0,0,0,.35),0 0 1px rgba(0,0,0,.5);
  --shadow-lg:0 8px 32px rgba(0,0,0,.55),0 0 1px rgba(0,0,0,.6);
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);}
body{font-family:var(--font-body);color:var(--text);-webkit-font-smoothing:antialiased;-webkit-tap-highlight-color:transparent;}

/* ‚îÄ‚îÄ TOPBAR ‚îÄ‚îÄ */
.topbar{
  position:fixed;top:0;left:0;right:0;height:var(--topbar-h);z-index:200;
  display:flex;align-items:center;gap:0;
  background:var(--topbar-bg);
  backdrop-filter:blur(24px);-webkit-backdrop-filter:blur(24px);
  border-bottom:1px solid var(--border);
}
.tb-section{display:flex;align-items:center;gap:6px;padding:0 14px;height:100%;}
.tb-section.center{flex:1;justify-content:center;}
.tb-section.right{justify-content:flex-end;margin-left:auto;}
.tb-divider{width:1px;height:24px;background:var(--border2);flex-shrink:0;}
.app-logo{font-family:var(--font-serif);font-size:17px;color:var(--text);letter-spacing:-.01em;}
.app-logo span{color:var(--accent);}
.tb-btn{
  display:flex;align-items:center;gap:5px;
  padding:5px 10px;border-radius:8px;
  font-family:var(--font-mono);font-size:10px;font-weight:500;letter-spacing:.02em;
  border:1px solid var(--border);background:var(--paper);
  color:var(--text2);cursor:pointer;transition:all .12s;
  white-space:nowrap;height:32px;
}
.tb-btn:hover{background:var(--bg2);border-color:var(--border2);}
.tb-btn.active,.tb-btn.accent{background:var(--accent);border-color:var(--accent2);color:#fff;}
.tb-btn.active:hover{background:var(--accent2);}
.tb-btn.ghost{border-color:transparent;background:transparent;}
.tb-btn.ghost:hover{background:var(--faint2);border-color:var(--border);}
.mode-group{display:flex;background:var(--bg3);border:1px solid var(--border);border-radius:9px;overflow:hidden;}
.mode-btn{padding:5px 12px;font-family:var(--font-mono);font-size:10px;font-weight:500;color:var(--muted);border:none;background:transparent;cursor:pointer;transition:all .12s;height:30px;}
.mode-btn:hover{color:var(--text2);}
.mode-btn.active{background:var(--paper);color:var(--text);box-shadow:0 1px 4px rgba(0,0,0,.1);}
.breadcrumb-title{font-family:var(--font-serif);font-size:15px;color:var(--text2);font-style:italic;max-width:280px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.note-count-badge{font-family:var(--font-mono);font-size:9px;color:var(--muted);padding:2px 7px;background:var(--bg3);border:1px solid var(--border);border-radius:20px;}

/* ‚îÄ‚îÄ LAYOUT ‚îÄ‚îÄ */
.layout{position:fixed;top:var(--topbar-h);bottom:0;left:0;right:0;display:flex;overflow:hidden;}

/* ‚îÄ‚îÄ SIDEBAR ‚îÄ‚îÄ */
.sidebar{
  width:var(--sidebar-w);flex-shrink:0;
  background:var(--paper);border-right:1px solid var(--border);
  display:flex;flex-direction:column;overflow:hidden;
  transition:transform .22s cubic-bezier(.4,0,.2,1);
  box-shadow:2px 0 8px rgba(0,0,0,.04);
}
.sidebar.hidden{transform:translateX(-100%);}
@media(max-width:800px){
  .sidebar{position:fixed;top:var(--topbar-h);bottom:0;z-index:150;transform:translateX(-100%);}
  .sidebar.open{transform:translateX(0);}
}
.sb-header{padding:14px 14px 10px;border-bottom:1px solid var(--border);}
.sb-new-btn{
  width:100%;padding:9px 14px;border-radius:var(--radius);
  background:var(--accent);border:none;color:#fff;
  font-family:var(--font-mono);font-size:11px;font-weight:500;
  cursor:pointer;display:flex;align-items:center;gap:8px;justify-content:center;
  transition:background .15s;
}
.sb-new-btn:hover{background:var(--accent2);}
.sb-search{
  width:100%;margin-top:10px;
  padding:8px 12px 8px 32px;border-radius:8px;
  background:var(--bg2);border:1px solid var(--border);
  font-family:var(--font-mono);font-size:11px;color:var(--text);
  outline:none;position:relative;
}
.sb-search-wrap{position:relative;}
.sb-search-wrap::before{content:'‚åï';position:absolute;left:10px;top:50%;transform:translateY(-50%);font-size:14px;color:var(--muted);pointer-events:none;z-index:1;}
.sb-search::placeholder{color:var(--muted);}
.sb-scroll{flex:1;overflow-y:auto;padding:10px 8px;}
.sb-scroll::-webkit-scrollbar{width:3px;}
.sb-scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
.sb-section-label{font-family:var(--font-mono);font-size:9px;font-weight:600;letter-spacing:.14em;text-transform:uppercase;color:var(--muted);padding:8px 8px 4px;}
.sb-note{
  display:flex;align-items:flex-start;gap:8px;
  padding:9px 10px;border-radius:10px;cursor:pointer;
  transition:all .12s;margin-bottom:2px;
  border:1px solid transparent;
}
.sb-note:hover{background:var(--bg2);}
.sb-note.active{background:var(--accentbg);border-color:rgba(212,88,10,.18);}
.sb-note-icon{font-size:16px;flex-shrink:0;margin-top:1px;line-height:1;}
.sb-note-body{flex:1;min-width:0;}
.sb-note-title{font-family:var(--font-body);font-size:12px;font-weight:500;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap;line-height:1.4;}
.sb-note-meta{font-family:var(--font-mono);font-size:9px;color:var(--muted);margin-top:2px;}
.sb-note-del{opacity:0;font-size:11px;color:var(--muted);padding:2px 5px;border-radius:4px;background:transparent;border:none;cursor:pointer;transition:all .12s;flex-shrink:0;}
.sb-note:hover .sb-note-del{opacity:1;}
.sb-note-del:hover{background:rgba(220,38,38,.1);color:var(--red);}
.sb-footer{padding:10px 12px;border-top:1px solid var(--border);flex-shrink:0;}
.sb-footer-stats{font-family:var(--font-mono);font-size:9px;color:var(--muted);display:flex;justify-content:space-between;}

/* ‚îÄ‚îÄ MAIN ‚îÄ‚îÄ */
.main{flex:1;display:flex;flex-direction:column;overflow:hidden;position:relative;min-width:0;}

/* ‚îÄ‚îÄ EMPTY STATE ‚îÄ‚îÄ */
.empty-state{
  position:absolute;inset:0;display:flex;flex-direction:column;
  align-items:center;justify-content:center;gap:20px;pointer-events:none;
  background:var(--paper);
}
.empty-icon{font-family:var(--font-serif);font-size:80px;font-style:italic;color:rgba(0,0,0,.06);}
.empty-title{font-family:var(--font-serif);font-size:22px;font-style:italic;color:var(--muted);}
.empty-hint{font-family:var(--font-mono);font-size:11px;color:rgba(0,0,0,.2);letter-spacing:.04em;}
.empty-cta{pointer-events:all;display:flex;gap:10px;}

/* ‚îÄ‚îÄ EDITOR VIEW ‚îÄ‚îÄ */
#editor-view{display:none;flex-direction:column;flex:1;overflow:hidden;background:var(--paper);}

/* ‚ïê‚ïê WRITE MODE ‚ïê‚ïê */
#write-pane{display:none;flex:1;overflow:hidden;flex-direction:column;}
#write-pane.active{display:flex;}
.write-scroll{flex:1;overflow-y:auto;padding:0;background:var(--paper);}
.write-scroll::-webkit-scrollbar{width:5px;}
.write-scroll::-webkit-scrollbar-thumb{background:var(--border2);border-radius:3px;}
.write-inner{max-width:760px;margin:0 auto;padding:40px 52px 120px;}
.note-title-input{
  width:100%;background:transparent;border:none;outline:none;
  font-family:var(--font-serif);font-size:38px;font-style:italic;
  color:var(--text);caret-color:var(--accent);line-height:1.2;
  padding:0 0 8px;margin-bottom:4px;
}
.note-title-input::placeholder{color:rgba(0,0,0,.2);}
.note-meta-row{display:flex;align-items:center;gap:10px;padding:8px 0 16px;border-bottom:2px solid var(--bg3);margin-bottom:20px;flex-wrap:wrap;}
.note-meta-item{font-family:var(--font-mono);font-size:10px;color:var(--muted);}
.note-tag{display:inline-flex;align-items:center;gap:3px;padding:2px 8px;border-radius:20px;font-family:var(--font-mono);font-size:9px;background:var(--accentbg);color:var(--accent);border:1px solid rgba(212,88,10,.2);cursor:pointer;}
.add-tag-btn{padding:2px 8px;border-radius:20px;font-family:var(--font-mono);font-size:9px;border:1px dashed var(--border2);background:transparent;color:var(--muted);cursor:pointer;transition:all .12s;}
.add-tag-btn:hover{border-color:var(--accent);color:var(--accent);}

#editor{
  min-height:60vh;font-family:var(--font-body);font-size:16px;
  line-height:1.85;color:var(--text2);outline:none;caret-color:var(--accent);
}
#editor:empty::before{content:attr(data-placeholder);color:rgba(0,0,0,.2);font-style:italic;pointer-events:none;}
#editor h1{font-family:var(--font-serif);font-size:32px;font-style:italic;color:var(--text);margin:32px 0 12px;line-height:1.2;}
#editor h2{font-family:var(--font-serif);font-size:24px;font-style:italic;color:var(--text);margin:24px 0 8px;}
#editor h3{font-family:var(--font-serif);font-size:18px;color:var(--text);margin:18px 0 6px;}
#editor strong{color:var(--text);font-weight:700;}
#editor em{font-style:italic;color:var(--text2);}
#editor a{color:var(--accent);text-decoration:underline;text-underline-offset:3px;}
#editor blockquote{margin:16px 0;padding:12px 20px;border-left:3px solid var(--accent);background:var(--accentbg);border-radius:0 8px 8px 0;font-style:italic;color:var(--text2);}
#editor ul,#editor ol{padding-left:24px;margin:8px 0;}
#editor li{margin:5px 0;}
#editor hr{border:none;border-top:2px solid var(--bg3);margin:28px 0;}
#editor p{margin-bottom:8px;}
.wikilink{color:var(--blue);border-bottom:1px dotted var(--blue);cursor:pointer;}
.wikilink:hover{background:rgba(37,99,235,.07);}

/* ‚îÄ‚îÄ INLINE CODE ‚îÄ‚îÄ */
#editor code.inline-code{
  font-family:var(--font-mono);font-size:13px;
  background:var(--bg3);border:1px solid var(--border2);
  padding:1px 6px;border-radius:5px;color:var(--accent2);
}

/* ‚ïê‚ïê FUNCTIONAL CODE BLOCK ‚ïê‚ïê */
.code-block-wrap{
  margin:18px 0;border-radius:12px;overflow:hidden;
  border:1px solid var(--border2);
  box-shadow:var(--shadow);
  background:#1e1e2e;
  position:relative;
}
.code-block-header{
  display:flex;align-items:center;gap:8px;
  padding:8px 14px;background:#181825;
  border-bottom:1px solid rgba(255,255,255,.06);
}
.code-lang-select{
  font-family:var(--font-mono);font-size:11px;font-weight:500;
  background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
  color:#cdd6f4;border-radius:6px;padding:3px 8px;cursor:pointer;outline:none;
}
.code-lang-select option{background:#1e1e2e;color:#cdd6f4;}
.code-spacer{flex:1;}
.code-run-btn{
  padding:4px 12px;border-radius:6px;font-family:var(--font-mono);font-size:10px;font-weight:600;
  border:none;background:rgba(166,227,161,.15);color:#a6e3a1;cursor:pointer;
  transition:all .12s;display:flex;align-items:center;gap:5px;
}
.code-run-btn:hover{background:rgba(166,227,161,.25);}
.code-copy-btn{
  padding:4px 10px;border-radius:6px;font-family:var(--font-mono);font-size:10px;
  border:1px solid rgba(255,255,255,.1);background:transparent;color:rgba(255,255,255,.4);
  cursor:pointer;transition:all .12s;
}
.code-copy-btn:hover{background:rgba(255,255,255,.08);color:rgba(255,255,255,.7);}
.code-editor-area{
  font-family:var(--font-mono);font-size:13px;line-height:1.7;
  color:#cdd6f4;background:#1e1e2e;
  padding:16px 18px;min-height:80px;
  outline:none;white-space:pre;overflow-x:auto;
  tab-size:2;
}
.code-editor-area:focus{outline:none;}
.code-editor-area::placeholder{color:rgba(205,214,244,.25);}
/* Highlighted view (non-editable) */
.code-highlighted{
  font-family:var(--font-mono);font-size:13px;line-height:1.7;
  background:#1e1e2e;padding:16px 18px;overflow-x:auto;
  cursor:text;
}
.code-highlighted .hljs{background:transparent;padding:0;}
.code-output{
  border-top:1px solid rgba(255,255,255,.06);
  background:#11111b;padding:10px 16px;
  font-family:var(--font-mono);font-size:12px;line-height:1.65;
  color:#a6e3a1;max-height:200px;overflow-y:auto;
  display:none;
}
.code-output.show{display:block;}
.code-output.error{color:#f38ba8;}
.code-output-label{font-size:9px;letter-spacing:.1em;color:rgba(255,255,255,.25);margin-bottom:4px;text-transform:uppercase;}

/* ‚ïê‚ïê FUNCTIONAL KANBAN ‚ïê‚ïê */
.kanban-wrap{
  margin:18px 0;background:var(--bg2);border:1px solid var(--border);
  border-radius:var(--radius);overflow:hidden;
  box-shadow:var(--shadow);
}
.kanban-header{
  display:flex;align-items:center;gap:10px;
  padding:10px 16px;background:var(--paper);
  border-bottom:1px solid var(--border);
}
.kanban-board-title{
  font-family:var(--font-serif);font-size:15px;font-style:italic;
  color:var(--text);flex:1;outline:none;background:transparent;border:none;
}
.kanban-board-title:focus{outline:1px solid var(--accent);outline-offset:3px;border-radius:3px;}
.kanban-add-col-btn{
  padding:4px 10px;border-radius:7px;font-family:var(--font-mono);font-size:10px;
  border:1px dashed var(--border2);background:transparent;color:var(--muted);cursor:pointer;
}
.kanban-add-col-btn:hover{border-color:var(--accent);color:var(--accent);}
.kanban-cols{display:flex;gap:12px;padding:14px;overflow-x:auto;min-height:280px;align-items:flex-start;}
.kanban-cols::-webkit-scrollbar{height:4px;}
.kanban-cols::-webkit-scrollbar-thumb{background:var(--border2);border-radius:2px;}
.kanban-col{
  min-width:220px;flex-shrink:0;
  background:var(--bg3);border:1px solid var(--border);
  border-radius:10px;display:flex;flex-direction:column;
  transition:border-color .15s;max-width:260px;
}
.kanban-col.drag-over{border-color:var(--accent);background:var(--accentbg);}
.kanban-col-header{
  display:flex;align-items:center;gap:8px;
  padding:10px 12px 8px;border-bottom:1px solid var(--border);
  flex-shrink:0;
}
.kanban-col-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.kanban-col-name{
  flex:1;font-family:var(--font-mono);font-size:10px;font-weight:600;
  letter-spacing:.08em;text-transform:uppercase;color:var(--text2);
  background:transparent;border:none;outline:none;
}
.kanban-col-name:focus{outline:1px solid var(--accent);outline-offset:2px;border-radius:2px;}
.kanban-col-count{font-family:var(--font-mono);font-size:9px;color:var(--muted);margin-left:auto;}
.kanban-col-del{font-size:10px;color:var(--muted);background:transparent;border:none;cursor:pointer;padding:2px 4px;border-radius:3px;opacity:0;transition:all .1s;}
.kanban-col-header:hover .kanban-col-del{opacity:1;}
.kanban-col-del:hover{background:rgba(220,38,38,.1);color:var(--red);}
.kanban-cards{flex:1;padding:8px;display:flex;flex-direction:column;gap:6px;min-height:60px;}
.kanban-card{
  background:var(--paper);border:1px solid var(--border);
  border-radius:8px;padding:10px 12px;cursor:grab;
  transition:all .15s;user-select:none;
  box-shadow:0 1px 3px rgba(0,0,0,.05);
}
.kanban-card:hover{box-shadow:var(--shadow);border-color:var(--border2);}
.kanban-card.dragging{opacity:.4;cursor:grabbing;}
.kanban-card-title{font-size:13px;color:var(--text);font-weight:500;line-height:1.4;word-break:break-word;}
.kanban-card-desc{font-family:var(--font-mono);font-size:10px;color:var(--muted);margin-top:4px;line-height:1.5;}
.kanban-card-meta{display:flex;align-items:center;gap:6px;margin-top:7px;}
.kanban-card-tag{font-family:var(--font-mono);font-size:9px;padding:1px 7px;border-radius:20px;font-weight:500;}
.kanban-card-actions{display:none;gap:4px;margin-left:auto;}
.kanban-card:hover .kanban-card-actions{display:flex;}
.kca-btn{font-size:10px;padding:1px 5px;border-radius:3px;background:transparent;border:1px solid var(--border);color:var(--muted);cursor:pointer;transition:all .1s;}
.kca-btn:hover{background:var(--bg3);color:var(--text);}
.kca-btn.del:hover{background:rgba(220,38,38,.1);color:var(--red);border-color:rgba(220,38,38,.2);}
.kanban-add-card{
  margin:6px 8px 8px;padding:7px 10px;border-radius:7px;
  font-family:var(--font-mono);font-size:10px;
  border:1px dashed var(--border2);background:transparent;color:var(--muted);
  cursor:pointer;text-align:left;transition:all .12s;
  display:flex;align-items:center;gap:6px;
}
.kanban-add-card:hover{border-color:var(--accent);color:var(--accent);background:var(--accentbg);}
.kanban-card-ghost{
  height:50px;background:var(--accentbg);border:2px dashed rgba(212,88,10,.3);
  border-radius:8px;
}

/* Card edit modal */
.card-modal{
  position:fixed;inset:0;z-index:800;background:rgba(0,0,0,.35);
  backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;padding:20px;
}
.card-modal.open{display:flex;}
.card-modal-body{
  background:var(--paper);border-radius:16px;
  padding:24px;width:100%;max-width:460px;
  box-shadow:var(--shadow-lg);animation:modal-in .18s cubic-bezier(.34,1.56,.64,1);
}
.cm-title{font-family:var(--font-serif);font-size:20px;font-style:italic;margin-bottom:16px;color:var(--text);}
.cm-input{
  width:100%;padding:10px 12px;border-radius:8px;
  background:var(--bg2);border:1px solid var(--border2);
  font-family:var(--font-body);font-size:14px;color:var(--text);
  outline:none;margin-bottom:10px;
}
.cm-input:focus{border-color:var(--accent);}
.cm-textarea{
  width:100%;padding:10px 12px;border-radius:8px;
  background:var(--bg2);border:1px solid var(--border2);
  font-family:var(--font-mono);font-size:12px;color:var(--text2);
  outline:none;resize:vertical;min-height:80px;line-height:1.6;margin-bottom:10px;
}
.cm-textarea:focus{border-color:var(--accent);}
.cm-label{font-family:var(--font-mono);font-size:10px;color:var(--muted);margin-bottom:5px;display:block;letter-spacing:.04em;}
.cm-row{display:flex;gap:8px;align-items:center;margin-bottom:10px;}
.cm-color-btn{width:20px;height:20px;border-radius:50%;border:2px solid transparent;cursor:pointer;transition:transform .12s;}
.cm-color-btn.sel{border-color:var(--text);transform:scale(1.2);}
.cm-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:14px;}
.cm-btn{padding:8px 18px;border-radius:8px;font-family:var(--font-mono);font-size:10px;font-weight:500;cursor:pointer;transition:all .15s;}
.cm-btn.cancel{border:1px solid var(--border);background:transparent;color:var(--muted);}
.cm-btn.cancel:hover{background:var(--bg2);}
.cm-btn.save{border:none;background:var(--accent);color:#fff;}
.cm-btn.save:hover{background:var(--accent2);}

/* ‚ïê‚ïê‚ïê GOODNOTES-STYLE DRAW PANE ‚ïê‚ïê‚ïê */
#draw-pane{display:none;flex:1;overflow:hidden;flex-direction:column;}
#draw-pane.active{display:flex;}

/* Left tool sidebar - GoodNotes style */
.draw-layout{flex:1;display:flex;overflow:hidden;}
.tool-sidebar{
  width:var(--tool-w);flex-shrink:0;
  background:var(--paper);border-right:1px solid var(--border);
  display:flex;flex-direction:column;align-items:center;
  padding:10px 0;gap:4px;overflow-y:auto;
  box-shadow:2px 0 8px rgba(0,0,0,.04);z-index:10;
}
.tool-sidebar::-webkit-scrollbar{display:none;}
.tool-group{display:flex;flex-direction:column;align-items:center;gap:3px;width:100%;padding:6px 0;}
.tool-group+.tool-group{border-top:1px solid var(--border);}
.tool-btn{
  width:40px;height:40px;border-radius:10px;
  border:1px solid transparent;background:transparent;
  cursor:pointer;display:flex;align-items:center;justify-content:center;
  font-size:18px;transition:all .12s;position:relative;
  flex-shrink:0;
}
.tool-btn:hover{background:var(--bg2);border-color:var(--border);}
.tool-btn.active{background:var(--accentbg);border-color:rgba(212,88,10,.25);}
.tool-btn .tool-label{
  position:absolute;bottom:-14px;left:50%;transform:translateX(-50%);
  font-family:var(--font-mono);font-size:8px;color:var(--muted);white-space:nowrap;
  pointer-events:none;
}
.tool-color-dot{
  width:22px;height:22px;border-radius:50%;border:2px solid transparent;
  cursor:pointer;transition:all .12s;flex-shrink:0;
}
.tool-color-dot.active{border-color:var(--text);box-shadow:0 0 0 2px var(--paper),0 0 0 4px var(--text);}
.tool-size-wrap{padding:6px 8px;width:100%;display:flex;flex-direction:column;align-items:center;gap:5px;}
.tool-size-label{font-family:var(--font-mono);font-size:8px;color:var(--muted);}
.tool-size-slider{
  -webkit-appearance:none;appearance:none;
  width:36px;height:80px;writing-mode:vertical-rl;direction:rtl;
  background:transparent;cursor:pointer;outline:none;
}
.tool-size-slider::-webkit-slider-runnable-track{width:3px;background:var(--border2);border-radius:2px;}
.tool-size-slider::-webkit-slider-thumb{-webkit-appearance:none;width:14px;height:14px;border-radius:50%;background:var(--accent);border:2px solid var(--paper);box-shadow:0 1px 4px rgba(0,0,0,.2);margin-left:-5px;}
.tool-undo-redo{display:flex;flex-direction:column;gap:3px;padding:4px 8px;}
.tur-btn{
  width:36px;height:28px;border-radius:7px;
  border:1px solid var(--border);background:var(--paper2);
  font-size:13px;cursor:pointer;display:flex;align-items:center;justify-content:center;
  transition:all .12s;
}
.tur-btn:hover{background:var(--bg2);border-color:var(--border2);}
.tur-btn:active{background:var(--bg3);}

/* Canvas area */
#canvas-area{flex:1;position:relative;overflow:hidden;background:var(--paper2);cursor:crosshair;touch-action:none;}
#canvas-area.tool-pan{cursor:grab;}
#canvas-area.tool-pan.panning{cursor:grabbing;}
#canvas-area.tool-eraser{cursor:none;}
#canvas-area.tool-scribble{cursor:none;}
#canvas-area.tool-lasso{cursor:crosshair;}
#bg-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}
#draw-canvas{position:absolute;top:0;left:0;width:100%;height:100%;}
#overlay-canvas{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;}

/* Custom cursors */
.eraser-cursor,.scribble-cursor,.lasso-cursor{
  position:absolute;pointer-events:none;z-index:20;display:none;transform:translate(-50%,-50%);
}
.eraser-cursor-inner{
  width:24px;height:24px;border-radius:50%;
  border:2px solid rgba(0,0,0,.5);background:rgba(255,255,255,.6);
}
.scribble-cursor-inner{
  width:28px;height:28px;border-radius:50%;
  border:2px dashed rgba(220,38,38,.6);background:rgba(220,38,38,.08);
}

/* HUD bottom bar */
.canvas-hud{
  position:absolute;bottom:0;left:0;right:0;height:30px;
  background:var(--hud-bg);backdrop-filter:blur(10px);
  border-top:1px solid var(--border);
  display:flex;align-items:center;gap:0;z-index:10;
  font-family:var(--font-mono);font-size:10px;
}
.hud-item{padding:0 14px;color:var(--muted);border-right:1px solid var(--border);height:100%;display:flex;align-items:center;gap:6px;flex-shrink:0;}
.hud-item:last-child{border-right:none;}
.hud-val{color:var(--text2);font-weight:500;}
.hud-spacer{flex:1;}
.hud-zoom-btn{padding:0 8px;height:100%;border:none;background:transparent;color:var(--muted);cursor:pointer;font-family:var(--font-mono);font-size:11px;font-weight:500;transition:all .1s;}
.hud-zoom-btn:hover{color:var(--text);background:var(--faint2);}
.hud-zoom-val{padding:0 10px;font-family:var(--font-mono);font-size:10px;font-weight:600;color:var(--text2);border-left:1px solid var(--border);border-right:1px solid var(--border);height:100%;display:flex;align-items:center;cursor:default;}

/* Top bar for draw mode */
.draw-topbar{
  display:flex;align-items:center;gap:8px;
  padding:6px 12px;background:var(--paper);
  border-bottom:1px solid var(--border);flex-shrink:0;
  overflow-x:auto;-webkit-overflow-scrolling:touch;
}
.draw-topbar::-webkit-scrollbar{display:none;}
.draw-tb-btn{
  padding:5px 11px;border-radius:8px;
  font-family:var(--font-mono);font-size:10px;font-weight:500;
  border:1px solid var(--border);background:var(--paper2);color:var(--text2);
  cursor:pointer;transition:all .12s;white-space:nowrap;height:30px;display:flex;align-items:center;gap:5px;
  flex-shrink:0;
}
.draw-tb-btn:hover{background:var(--bg2);border-color:var(--border2);}
.draw-tb-btn.active-bg{border-color:var(--accent);background:var(--accentbg);color:var(--accent);}
.draw-tb-sep{width:1px;height:20px;background:var(--border);flex-shrink:0;}
.pdf-progress{display:none;align-items:center;gap:8px;flex-shrink:0;}
.pdf-progress.show{display:flex;}
.pdf-progress-bar{width:120px;height:4px;background:var(--bg3);border-radius:2px;overflow:hidden;}
.pdf-progress-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .25s;}
.pdf-progress-text{font-family:var(--font-mono);font-size:9px;color:var(--muted);}

/* Page thumbnails strip */
.pages-strip{
  display:flex;flex-direction:column;gap:8px;
  padding:10px 6px;background:var(--bg2);
  border-left:1px solid var(--border);
  overflow-y:auto;width:80px;flex-shrink:0;
  align-items:center;
}
.pages-strip::-webkit-scrollbar{display:none;}
.page-thumb{
  width:60px;height:80px;border-radius:6px;
  border:2px solid var(--border);background:var(--paper);
  cursor:pointer;transition:all .15s;overflow:hidden;
  display:flex;align-items:center;justify-content:center;
  flex-shrink:0;position:relative;
}
.page-thumb.active{border-color:var(--accent);box-shadow:0 0 0 2px var(--accentbg);}
.page-thumb:hover:not(.active){border-color:var(--border2);}
.page-thumb-num{position:absolute;bottom:3px;left:0;right:0;text-align:center;font-family:var(--font-mono);font-size:7px;color:var(--muted);}
.page-add-btn{
  width:60px;height:34px;border-radius:6px;
  border:1.5px dashed var(--border2);background:transparent;
  cursor:pointer;font-size:16px;color:var(--muted);
  display:flex;align-items:center;justify-content:center;
  transition:all .12s;flex-shrink:0;
}
.page-add-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accentbg);}

/* ‚ïê‚ïê‚ïê MIXED PANE ‚ïê‚ïê‚ïê */
#mixed-pane{display:none;flex:1;overflow:hidden;}
#mixed-pane.active{display:flex;}
.mixed-write{width:50%;display:flex;flex-direction:column;overflow:hidden;border-right:1px solid var(--border);}
.mixed-draw-area{flex:1;display:flex;flex-direction:column;overflow:hidden;}
.mixed-hd{padding:7px 14px;font-family:var(--font-mono);font-size:9px;font-weight:600;letter-spacing:.12em;text-transform:uppercase;color:var(--muted);border-bottom:1px solid var(--border);flex-shrink:0;background:var(--paper);display:flex;align-items:center;gap:8px;}
#mixed-canvas-area{flex:1;position:relative;overflow:hidden;background:var(--paper2);touch-action:none;}
#mixed-canvas{position:absolute;top:0;left:0;}
#mixed-bg-canvas{position:absolute;top:0;left:0;pointer-events:none;}

/* ‚ïê‚ïê‚ïê FLOAT FORMAT BAR ‚ïê‚ïê‚ïê */
.fmt-bar{
  position:fixed;z-index:300;
  background:var(--text);border-radius:10px;
  padding:4px 6px;display:flex;align-items:center;gap:1px;
  box-shadow:var(--shadow-lg);
  opacity:0;pointer-events:none;transition:opacity .15s,transform .15s;transform:translateY(5px);
}
.fmt-bar.visible{opacity:1;pointer-events:all;transform:translateY(0);}
.fb-btn{padding:5px 8px;border-radius:6px;font-family:var(--font-mono);font-size:11px;border:none;background:transparent;color:rgba(255,255,255,.6);cursor:pointer;transition:all .1s;min-width:28px;text-align:center;}
.fb-btn:hover{background:rgba(255,255,255,.12);color:#fff;}
.fb-sep{width:1px;height:16px;background:rgba(255,255,255,.15);margin:0 2px;}

/* ‚ïê‚ïê‚ïê SLASH MENU ‚ïê‚ïê‚ïê */
.slash-menu{
  position:fixed;z-index:400;
  background:var(--paper);border:1px solid var(--border2);border-radius:var(--radius);
  padding:6px;width:270px;box-shadow:var(--shadow-lg);display:none;
}
.slash-menu.open{display:block;}
.slash-search{
  width:100%;background:var(--bg2);border:1px solid var(--border);border-radius:8px;
  outline:none;padding:7px 10px;font-family:var(--font-mono);font-size:11px;
  color:var(--text);margin-bottom:6px;
}
.slash-search::placeholder{color:var(--muted);}
.slash-item{display:flex;align-items:center;gap:10px;padding:7px 10px;border-radius:8px;cursor:pointer;transition:all .1s;}
.slash-item:hover,.slash-item.focus{background:var(--accentbg);}
.slash-icon{font-size:16px;width:24px;text-align:center;flex-shrink:0;}
.slash-label{font-size:12px;font-weight:500;color:var(--text2);}
.slash-desc{font-family:var(--font-mono);font-size:9px;color:var(--muted);}

/* ‚ïê‚ïê‚ïê GRAPH OVERLAY ‚ïê‚ïê‚ïê */
.graph-overlay{position:fixed;inset:0;z-index:600;background:var(--bg);opacity-filter:blur(0);display:none;flex-direction:column;}
.graph-overlay.open{display:flex;}
.graph-hd{display:flex;align-items:center;gap:12px;padding:14px 20px;border-bottom:1px solid var(--border);}
.graph-title{font-family:var(--font-serif);font-size:18px;font-style:italic;color:var(--text);flex:1;}
#graph-canvas{flex:1;display:block;}

/* ‚ïê‚ïê‚ïê MODAL ‚ïê‚ïê‚ïê */
.modal-overlay{position:fixed;inset:0;z-index:500;background:rgba(0,0,0,.3);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;padding:20px;}
.modal-overlay.open{display:flex;}
.modal{background:var(--paper);border:1px solid var(--border2);border-radius:16px;padding:26px;width:100%;max-width:420px;box-shadow:var(--shadow-lg);animation:modal-in .18s cubic-bezier(.34,1.56,.64,1);}
@keyframes modal-in{from{opacity:0;transform:scale(.93) translateY(12px)}to{opacity:1;transform:scale(1) translateY(0)}}
.modal-title{font-family:var(--font-serif);font-size:20px;font-style:italic;margin-bottom:16px;color:var(--text);}
.modal-input{width:100%;background:var(--bg2);border:1px solid var(--border2);border-radius:9px;padding:11px 13px;font-family:var(--font-body);font-size:14px;color:var(--text);outline:none;margin-bottom:12px;}
.modal-input:focus{border-color:var(--accent);}
.modal-actions{display:flex;gap:8px;justify-content:flex-end;}
.modal-btn{padding:9px 20px;border-radius:9px;font-family:var(--font-mono);font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;}
.modal-btn.cancel{border:1px solid var(--border);background:transparent;color:var(--muted);}
.modal-btn.cancel:hover{background:var(--bg2);}
.modal-btn.confirm{border:none;background:var(--accent);color:#fff;}
.modal-btn.confirm:hover{background:var(--accent2);}

/* ‚ïê‚ïê‚ïê TOAST ‚ïê‚ïê‚ïê */
.toast{position:fixed;bottom:40px;left:50%;transform:translateX(-50%) translateY(8px);z-index:9000;background:var(--text);border-radius:10px;padding:8px 18px;font-family:var(--font-mono);font-size:10px;color:#fff;opacity:0;pointer-events:none;transition:all .25s cubic-bezier(.34,1.56,.64,1);white-space:nowrap;box-shadow:var(--shadow-lg);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.accent{background:var(--accent);}
.toast.green{background:var(--green);}

/* Sidebar overlay mobile */
.sb-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:140;}
@media(max-width:800px){.sb-overlay.show{display:block;}}

/* Word count bar */
.wc-bar{
  position:absolute;bottom:0;left:var(--sidebar-w);right:0;height:26px;z-index:50;
  display:flex;align-items:center;gap:0;
  background:var(--hud-bg);backdrop-filter:blur(10px);
}
.wc-bar.no-sb{left:0;}
.wc-item{display:flex;align-items:center;gap:5px;padding:0 12px;color:var(--muted);border-right:1px solid var(--border);height:100%;}
.wc-val{color:var(--text2);font-weight:500;}
.wc-hint{color:rgba(0,0,0,.2);font-size:9px;}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê TOPBAR ‚ïê‚ïê‚ïê -->
<div class="topbar">
  <div class="tb-section">
    <button class="tb-btn ghost" onclick="toggleSidebar()" style="padding:5px 9px;font-size:14px;">‚ò∞</button>
    <div class="app-logo">Canvas<span>.</span></div>
    <div class="tb-divider"></div>
    <div class="mode-group">
      <button class="mode-btn active" id="mt-write" onclick="setMode('write')">Write</button>
      <button class="mode-btn" id="mt-draw"  onclick="setMode('draw')">Draw</button>
      <button class="mode-btn" id="mt-mixed" onclick="setMode('mixed')">Both</button>
    </div>
  </div>

  <div class="tb-section center">
    <div class="breadcrumb-title" id="breadcrumb-title">Select a note</div>
  </div>

  <div class="tb-section right">
    <span class="note-count-badge" id="note-count-badge">0 notes</span>
    <button class="tb-btn" onclick="showGraph()" title="Note graph">‚óâ Graph</button>
    <button class="tb-btn" onclick="toggleTheme()" id="theme-btn" title="Toggle dark/light mode">‚òæ Dark</button>
    <button class="tb-btn active" onclick="newNote()">+ New Note</button>
  </div>
</div>

<!-- Mobile overlay -->
<div class="sb-overlay" id="sb-overlay" onclick="closeSidebar()"></div>

<!-- ‚ïê‚ïê‚ïê LAYOUT ‚ïê‚ïê‚ïê -->
<div class="layout">

  <!-- SIDEBAR -->
  <div class="sidebar" id="sidebar">
    <div class="sb-header">
      <button class="sb-new-btn" onclick="newNote()">‚ú¶ New Note</button>
      <div class="sb-search-wrap" style="margin-top:10px;">
        <input type="text" class="sb-search" id="sb-search" placeholder="Search notes‚Ä¶" oninput="searchNotes(this.value)">
      </div>
    </div>
    <div class="sb-scroll">
      <div class="sb-section-label">All Notes</div>
      <div id="note-list"></div>
    </div>
    <div class="sb-footer">
      <div class="sb-footer-stats">
        <span id="sb-stats-notes">0 notes</span>
        <span id="sb-stats-words">0 words</span>
      </div>
    </div>
  </div>

  <!-- MAIN -->
  <div class="main" id="main">

    <div class="empty-state" id="empty-state">
      <div class="empty-icon">‚ú¶</div>
      <div class="empty-title">Your canvas awaits</div>
      <div class="empty-hint">CREATE A NOTE OR SELECT FROM SIDEBAR</div>
      <div class="empty-cta">
        <button class="tb-btn active" onclick="newNote()">+ New Note</button>
      </div>
    </div>

    <!-- EDITOR VIEW -->
    <div id="editor-view">

      <!-- ‚ïê‚ïê WRITE PANE ‚ïê‚ïê -->
      <div id="write-pane">
        <div class="write-scroll" id="write-scroll">
          <div class="write-inner">
            <input type="text" class="note-title-input" id="note-title" placeholder="Untitled note‚Ä¶" oninput="onTitleChange()">
            <div class="note-meta-row">
              <span class="note-meta-item" id="meta-date">‚Äî</span>
              <span class="note-meta-item" id="meta-wc">0 words</span>
              <div id="tag-row" style="display:flex;align-items:center;gap:5px;flex-wrap:wrap;"></div>
              <button class="add-tag-btn" onclick="promptTag()">+ tag</button>
            </div>
            <div id="editor" contenteditable="true" spellcheck="true"
              data-placeholder="Start writing‚Ä¶ type / for blocks, # for headings, ** for bold"></div>
          </div>
        </div>
        <!-- Word count -->
        <div class="wc-bar" id="wc-bar">
          <div class="wc-item"><span>Words</span><span class="wc-val" id="wc-words">0</span></div>
          <div class="wc-item"><span>Chars</span><span class="wc-val" id="wc-chars">0</span></div>
          <div class="wc-item" style="margin-left:auto;border-right:none;">
            <span class="wc-hint">/ blocks ¬∑ [[link]] ¬∑ # H1 ¬∑ **bold**</span>
          </div>
        </div>
      </div>

      <!-- ‚ïê‚ïê DRAW PANE ‚ïê‚ïê -->
      <div id="draw-pane">
        <!-- Top bar -->
        <div class="draw-topbar">
          <button class="draw-tb-btn" onclick="triggerPdfImport()">üìÑ Import PDF</button>
          <input type="file" id="pdf-input" accept="application/pdf" style="display:none" onchange="handlePdfFile(this)">
          <div class="draw-tb-sep"></div>
          <button class="draw-tb-btn" id="bg-plain-btn"  onclick="setBg('plain')">‚òê Plain</button>
          <button class="draw-tb-btn active-bg" id="bg-grid-btn"   onclick="setBg('grid')">‚äû Grid</button>
          <button class="draw-tb-btn" id="bg-lined-btn"  onclick="setBg('lined')">‚â° Lines</button>
          <button class="draw-tb-btn" id="bg-dots-btn"   onclick="setBg('dots')">‚†ø Dots</button>
          <div class="draw-tb-sep"></div>
          <button class="draw-tb-btn" onclick="exportPNG()">‚¨á Export PNG</button>
          <div class="draw-tb-sep"></div>
          <div class="pdf-progress" id="pdf-progress">
            <div class="pdf-progress-bar"><div class="pdf-progress-fill" id="pdf-fill"></div></div>
            <span class="pdf-progress-text" id="pdf-text">Loading‚Ä¶</span>
          </div>
        </div>

        <div class="draw-layout">
          <!-- LEFT TOOL SIDEBAR - GoodNotes style -->
          <div class="tool-sidebar">
            <!-- Drawing tools -->
            <div class="tool-group">
              <button class="tool-btn active" id="tool-pen" onclick="setTool('pen')" title="Pen (P)">‚úèÔ∏è</button>
              <button class="tool-btn" id="tool-marker" onclick="setTool('marker')" title="Marker (M)">üñäÔ∏è</button>
              <button class="tool-btn" id="tool-highlighter" onclick="setTool('highlighter')" title="Highlighter (H)">üñåÔ∏è</button>
            </div>
            <div class="tool-group">
              <button class="tool-btn" id="tool-eraser" onclick="setTool('eraser')" title="Eraser (E)">üßπ</button>
              <button class="tool-btn" id="tool-scribble" onclick="setTool('scribble')" title="Scribble Erase (X)" style="font-size:14px;font-family:var(--font-mono);color:var(--red);font-weight:700;">‚úó</button>
            </div>
            <div class="tool-group">
              <button class="tool-btn" id="tool-line"   onclick="setTool('line')" title="Line">‚ï±</button>
              <button class="tool-btn" id="tool-rect"   onclick="setTool('rect')" title="Rectangle">‚ñ°</button>
              <button class="tool-btn" id="tool-circle" onclick="setTool('circle')" title="Circle">‚óã</button>
              <button class="tool-btn" id="tool-arrow"  onclick="setTool('arrow')" title="Arrow">‚Üí</button>
            </div>
            <div class="tool-group">
              <button class="tool-btn" id="tool-text" onclick="setTool('text')" title="Text (T)" style="font-family:var(--font-serif);font-size:20px;font-style:italic;">T</button>
              <button class="tool-btn" id="tool-pan" onclick="setTool('pan')" title="Pan (V)">‚ú•</button>
            </div>
            <!-- Colors -->
            <div class="tool-group" style="gap:6px;padding:8px 0;">
              <div class="tool-color-dot active" style="background:#1a1916" onclick="setColor('#1a1916',this)" title="Black"></div>
              <div class="tool-color-dot" style="background:#d4580a" onclick="setColor('#d4580a',this)" title="Amber"></div>
              <div class="tool-color-dot" style="background:#2563eb" onclick="setColor('#2563eb',this)" title="Blue"></div>
              <div class="tool-color-dot" style="background:#16a34a" onclick="setColor('#16a34a',this)" title="Green"></div>
              <div class="tool-color-dot" style="background:#dc2626" onclick="setColor('#dc2626',this)" title="Red"></div>
              <div class="tool-color-dot" style="background:#7c3aed" onclick="setColor('#7c3aed',this)" title="Purple"></div>
              <div class="tool-color-dot" style="background:#ca8a04" onclick="setColor('#ca8a04',this)" title="Yellow"></div>
              <div class="tool-color-dot" style="background:#0891b2" onclick="setColor('#0891b2',this)" title="Teal"></div>
            </div>
            <!-- Size slider -->
            <div class="tool-group">
              <div class="tool-size-wrap">
                <input type="range" class="tool-size-slider" id="tool-size" min="1" max="32" value="3" oninput="setSize(+this.value)">
                <span class="tool-size-label" id="size-val">3px</span>
              </div>
            </div>
            <!-- Undo/Redo -->
            <div class="tool-group">
              <div class="tool-undo-redo">
                <button class="tur-btn" onclick="undoDraw()" title="Undo (‚åòZ)">‚Ü©</button>
                <button class="tur-btn" onclick="redoDraw()" title="Redo (‚åòY)">‚Ü™</button>
                <button class="tur-btn" onclick="clearPage()" title="Clear page" style="color:var(--red);font-size:11px;font-family:var(--font-mono);">CLR</button>
              </div>
            </div>
          </div>

          <!-- INFINITE CANVAS -->
          <div id="canvas-area">
            <canvas id="bg-canvas"></canvas>
            <canvas id="draw-canvas"></canvas>
            <canvas id="overlay-canvas"></canvas>
            <div class="eraser-cursor" id="eraser-cursor"><div class="eraser-cursor-inner"></div></div>
            <div class="scribble-cursor" id="scribble-cursor"><div class="scribble-cursor-inner"></div></div>
            <!-- HUD -->
            <div class="canvas-hud">
              <div class="hud-item"><span>Tool</span><span class="hud-val" id="hud-tool">Pen</span></div>
              <div class="hud-item"><span>Size</span><span class="hud-val" id="hud-size">3px</span></div>
              <div class="hud-item"><span>Strokes</span><span class="hud-val" id="hud-strokes">0</span></div>
              <div class="hud-spacer"></div>
              <button class="hud-zoom-btn" onclick="zoomStep(-0.2)">‚àí</button>
              <div class="hud-zoom-val" id="hud-zoom">100%</div>
              <button class="hud-zoom-btn" onclick="zoomStep(0.2)">+</button>
              <button class="hud-zoom-btn" onclick="resetViewport()" style="padding:0 12px;border-left:1px solid var(--border);">Reset</button>
              <button class="hud-zoom-btn" onclick="fitToContent()" style="padding:0 12px;border-left:1px solid var(--border);">Fit</button>
            </div>
          </div>

          <!-- PAGE THUMBNAILS -->
          <div class="pages-strip" id="pages-strip"></div>
        </div>
      </div>

      <!-- ‚ïê‚ïê MIXED PANE ‚ïê‚ïê -->
      <div id="mixed-pane">
        <div class="mixed-write">
          <div class="mixed-hd">‚úé Write</div>
          <div style="flex:1;overflow-y:auto;padding:20px 24px 60px;">
            <div id="editor-mixed" contenteditable="true" spellcheck="true"
              style="min-height:300px;font-family:var(--font-body);font-size:15px;line-height:1.8;color:var(--text2);outline:none;caret-color:var(--accent);"
              data-placeholder="Write here‚Ä¶"></div>
          </div>
        </div>
        <div class="mixed-draw-area">
          <div class="mixed-hd">
            ‚úè Draw
            <button class="draw-tb-btn" id="mx-pen"   onclick="setTool('pen')"         style="height:22px;padding:2px 8px;font-size:9px;margin-left:4px;">Pen</button>
            <button class="draw-tb-btn" id="mx-hl"    onclick="setTool('highlighter')" style="height:22px;padding:2px 8px;font-size:9px;">HL</button>
            <button class="draw-tb-btn" id="mx-erase" onclick="setTool('scribble')"    style="height:22px;padding:2px 8px;font-size:9px;color:var(--red);">‚úó</button>
            <button class="draw-tb-btn" id="mx-pan"   onclick="setTool('pan')"         style="height:22px;padding:2px 8px;font-size:9px;">Pan</button>
          </div>
          <div id="mixed-canvas-area">
            <canvas id="mixed-bg-canvas"></canvas>
            <canvas id="mixed-canvas"></canvas>
          </div>
        </div>
      </div>

    </div><!-- /editor-view -->

  </div><!-- /main -->
</div><!-- /layout -->

<!-- FORMAT BAR -->
<div class="fmt-bar" id="fmt-bar">
  <button class="fb-btn" onclick="fmt('bold')"><b>B</b></button>
  <button class="fb-btn" onclick="fmt('italic')"><i>I</i></button>
  <button class="fb-btn" onclick="fmt('underline')" style="text-decoration:underline">U</button>
  <button class="fb-btn" onclick="fmt('strikeThrough')"><s>S</s></button>
  <div class="fb-sep"></div>
  <button class="fb-btn" onclick="fmtBlock('h1')">H1</button>
  <button class="fb-btn" onclick="fmtBlock('h2')">H2</button>
  <button class="fb-btn" onclick="fmtBlock('h3')">H3</button>
  <div class="fb-sep"></div>
  <button class="fb-btn" onclick="fmt('insertUnorderedList')">‚Ä¢ list</button>
  <button class="fb-btn" onclick="fmt('insertOrderedList')">1.</button>
  <button class="fb-btn" onclick="doQuote()">‚ùù</button>
  <div class="fb-sep"></div>
  <button class="fb-btn" onclick="doLink()">üîó</button>
</div>

<!-- SLASH MENU -->
<div class="slash-menu" id="slash-menu">
  <input class="slash-search" id="slash-search" placeholder="Search blocks‚Ä¶" oninput="filterSlash(this.value)">
  <div id="slash-list"></div>
</div>

<!-- GRAPH -->
<div class="graph-overlay" id="graph-overlay">
  <div class="graph-hd">
    <div class="graph-title">Note Graph</div>
    <button class="tb-btn" onclick="closeGraph()" style="margin-left:auto;">‚úï Close</button>
  </div>
  <canvas id="graph-canvas"></canvas>
</div>

<!-- MAIN MODAL -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
  <div class="modal">
    <div class="modal-title" id="modal-title">‚Äî</div>
    <input type="text" class="modal-input" id="modal-input" onkeydown="if(event.key==='Enter')confirmModal()">
    <div class="modal-actions">
      <button class="modal-btn cancel" onclick="closeModal()">Cancel</button>
      <button class="modal-btn confirm" onclick="confirmModal()">OK</button>
    </div>
  </div>
</div>

<!-- CARD EDIT MODAL -->
<div class="card-modal" id="card-modal" onclick="if(event.target===this)closeCardModal()">
  <div class="card-modal-body">
    <div class="cm-title" id="cm-title">Edit Card</div>
    <label class="cm-label">Title</label>
    <input type="text" class="cm-input" id="cm-card-title" placeholder="Card title‚Ä¶">
    <label class="cm-label">Description</label>
    <textarea class="cm-textarea" id="cm-card-desc" placeholder="Add a description‚Ä¶"></textarea>
    <label class="cm-label">Label color</label>
    <div class="cm-row" id="cm-colors">
      <div class="cm-color-btn sel" style="background:#6b7280;" data-color="#6b7280" onclick="selectCardColor(this)"></div>
      <div class="cm-color-btn" style="background:#dc2626;" data-color="#dc2626" onclick="selectCardColor(this)"></div>
      <div class="cm-color-btn" style="background:#d4580a;" data-color="#d4580a" onclick="selectCardColor(this)"></div>
      <div class="cm-color-btn" style="background:#ca8a04;" data-color="#ca8a04" onclick="selectCardColor(this)"></div>
      <div class="cm-color-btn" style="background:#16a34a;" data-color="#16a34a" onclick="selectCardColor(this)"></div>
      <div class="cm-color-btn" style="background:#2563eb;" data-color="#2563eb" onclick="selectCardColor(this)"></div>
      <div class="cm-color-btn" style="background:#7c3aed;" data-color="#7c3aed" onclick="selectCardColor(this)"></div>
    </div>
    <div class="cm-actions">
      <button class="cm-btn cancel" onclick="closeCardModal()">Cancel</button>
      <button class="cm-btn save" onclick="saveCard()">Save Card</button>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THE CANVAS v3  ‚Äî  GoodNotes-style + Functional Blocks
//  Functional: Kanban (drag/drop/edit) ¬∑ Code (highlight/run)
//  Drawing: Pressure, scribble-erase, infinite canvas
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

if (typeof pdfjsLib !== 'undefined')
  pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

// ‚îÄ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let notes = {}, folders = {}, activeNote = null;
let currentMode = 'write';
let modalCallback = null, toastTimer, saveTimer;

// Draw
let drawTool = 'pen', drawColor = '#1a1916', drawSize = 3;
let isDrawing = false, isPanning = false;
let currentStroke = null, startPt = null;
let panStart = null, panVpStart = null;
let drawData = {};   // noteId ‚Üí { pages: [[stroke,...]], page: 0 }
let undoStacks = {}, redoStacks = {};
let viewports = {};  // noteId ‚Üí { x, y, scale }
let scribblePts = [], scribbleTimer = null;
let palmOn = true;
let drawingPointerId = null;
let activePointers = new Map();
let currentBg = 'grid';
let mixVP = { x: 0, y: 0, scale: 1 };

// Canvas refs
let mainCvs, mainCtx, bgCvs, bgCtx, overlayCvs, overlayCtx;
let mixCvs, mixCtx, mixBgCvs, mixBgCtx;

// Kanban drag state
let dragCard = null, dragCardData = null, dragGhost = null;
let editingCardId = null, editingKanbanEl = null;
let cardModalCb = null;

// ‚îÄ‚îÄ‚îÄ SLASH BLOCKS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const SLASH_BLOCKS = [
  {id:'h1',      icon:'H‚ÇÅ', label:'Heading 1',    desc:'Large heading',     fn:()=>fmtBlock('h1')},
  {id:'h2',      icon:'H‚ÇÇ', label:'Heading 2',    desc:'Medium heading',    fn:()=>fmtBlock('h2')},
  {id:'h3',      icon:'H‚ÇÉ', label:'Heading 3',    desc:'Small heading',     fn:()=>fmtBlock('h3')},
  {id:'bullet',  icon:'‚Ä¢',  label:'Bullet List',  desc:'Unordered list',    fn:()=>fmt('insertUnorderedList')},
  {id:'numbered',icon:'1.', label:'Numbered List',desc:'Ordered list',      fn:()=>fmt('insertOrderedList')},
  {id:'quote',   icon:'‚ùù',  label:'Blockquote',   desc:'Indented quote',    fn:doQuote},
  {id:'code',    icon:'<>', label:'Code Block',   desc:'Highlighted + runnable', fn:insertCodeBlock},
  {id:'kanban',  icon:'‚ñ¶',  label:'Kanban Board', desc:'Drag-drop task board', fn:insertKanban},
  {id:'hr',      icon:'‚îÄ',  label:'Divider',      desc:'Horizontal rule',   fn:()=>{document.execCommand('insertHTML',false,'<hr>');edFocus();}},
  {id:'wikilink',icon:'[[', label:'Wiki Link',    desc:'Link to note',      fn:doWikilink},
];

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  STORAGE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function save() {
  try {
    localStorage.setItem('cv3_notes', JSON.stringify(notes));
    // Strip large raster data before saving drawData
    const sd = {};
    for (const id in drawData) {
      sd[id] = {
        pages: drawData[id].pages.map(pg =>
          pg.filter(s => s.tool !== 'raster' && s.tool !== 'pdf_page')
        ),
        page: drawData[id].page
      };
    }
    localStorage.setItem('cv3_draw', JSON.stringify(sd));
    localStorage.setItem('cv3_vp', JSON.stringify(viewports));
  } catch(e) { console.warn('storage full', e); }
}
function load() {
  try {
    const n = localStorage.getItem('cv3_notes');
    const d = localStorage.getItem('cv3_draw');
    const v = localStorage.getItem('cv3_vp');
    if (n) notes = JSON.parse(n);
    if (d) drawData = JSON.parse(d);
    if (v) viewports = JSON.parse(v);
  } catch {}
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  INIT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function init() {
  load();
  if (!Object.keys(notes).length) seedDefaults();
  renderNoteList(); updateStats();
  const ids = Object.keys(notes);
  if (ids.length) openNote(ids[0]);

  const ed = document.getElementById('editor');
  ed.addEventListener('input', onEditorInput);
  ed.addEventListener('mouseup', showFmtBar);
  ed.addEventListener('keyup', showFmtBar);
  ed.addEventListener('keydown', editorKey);
  document.getElementById('editor-mixed').addEventListener('input', onMixedInput);

  document.addEventListener('mousedown', e => {
    if (!document.getElementById('fmt-bar').contains(e.target)) hideFmtBar();
    if (!document.getElementById('slash-menu').contains(e.target)) closeSlash();
  });
  document.getElementById('slash-search').addEventListener('keydown', slashKeys);
  document.getElementById('b-inp-dummy')?.remove();
  document.addEventListener('keydown', globalKeys);

  initCanvases();
  buildSlashList(SLASH_BLOCKS);
  setupPdfDrop();

  if (window.innerWidth > 800) {
    document.getElementById('sidebar').classList.remove('hidden');
  }
}

function seedDefaults() {
  const id = createNote('Getting Started', `<h1>Welcome to Canvas v3</h1>
<p>This is a <strong>GoodNotes + Notion</strong> hybrid. Try the blocks below:</p>
<p>Type <code class="inline-code">/</code> anywhere to insert a block. The <strong>Kanban board</strong> and <strong>Code block</strong> are fully functional.</p>`, ['guide']);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  NOTE CRUD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function createNote(title='Untitled', content='', tags=[]) {
  const id = 'n_'+Date.now()+'_'+Math.random().toString(36).slice(2,5);
  notes[id] = { id, title, content, tags, created: new Date().toISOString(), modified: new Date().toISOString(), hasDrawing: false, _wc: 0 };
  save(); return id;
}
function newNote() {
  const id = createNote();
  renderNoteList(); openNote(id);
  setTimeout(() => document.getElementById('note-title').select(), 60);
  toast('New note ‚ú¶', 'accent');
  if (window.innerWidth <= 800) closeSidebar();
}
function deleteNote(id, e) {
  e?.stopPropagation();
  if (Object.keys(notes).length <= 1) { toast('Cannot delete last note'); return; }
  if (!confirm(`Delete "${notes[id]?.title||'note'}"?`)) return;
  delete notes[id]; delete drawData[id]; delete viewports[id]; save();
  if (activeNote === id) {
    activeNote = null;
    const rem = Object.keys(notes);
    if (rem.length) openNote(rem[0]);
    else {
      document.getElementById('editor-view').style.display = 'none';
      document.getElementById('empty-state').style.display = 'flex';
    }
  }
  renderNoteList(); updateStats();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  OPEN NOTE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openNote(id) {
  if (!notes[id]) return;
  activeNote = id;
  const n = notes[id];
  document.getElementById('empty-state').style.display = 'none';
  document.getElementById('editor-view').style.display = 'flex';
  document.getElementById('note-title').value = n.title;
  document.getElementById('editor').innerHTML = n.content || '';
  document.getElementById('editor-mixed').innerHTML = n.contentMixed || '';
  document.getElementById('meta-date').textContent =
    new Date(n.modified).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
  renderTagRow(n.tags);
  updateWordCount();
  document.getElementById('breadcrumb-title').textContent = n.title || 'Untitled';
  document.querySelectorAll('.sb-note').forEach(el => el.classList.toggle('active', el.dataset.id === id));

  if (!drawData[id]) drawData[id] = { pages: [[]], page: 0 };
  if (!undoStacks[id]) undoStacks[id] = [];
  if (!redoStacks[id]) redoStacks[id] = [];

  // Re-init code blocks + kanban in loaded content
  setTimeout(() => {
    initAllCodeBlocks();
    renderPagesStrip();
    resizeAllCanvases();
    redrawMain();
    redrawBg();
    updateHUD();
  }, 50);

  setMode(currentMode);
  if (window.innerWidth <= 800) closeSidebar();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TITLE / CONTENT CHANGES
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function onTitleChange() {
  if (!activeNote) return;
  notes[activeNote].title = document.getElementById('note-title').value;
  notes[activeNote].modified = new Date().toISOString();
  document.getElementById('breadcrumb-title').textContent = notes[activeNote].title || 'Untitled';
  debounceSave(); renderNoteList();
}
function onEditorInput() {
  if (!activeNote) return;
  notes[activeNote].content = document.getElementById('editor').innerHTML;
  notes[activeNote].modified = new Date().toISOString();
  updateWordCount(); debounceSave();
}
function onMixedInput() {
  if (!activeNote) return;
  notes[activeNote].contentMixed = document.getElementById('editor-mixed').innerHTML;
  debounceSave();
}
function debounceSave() { clearTimeout(saveTimer); saveTimer = setTimeout(() => { save(); updateStats(); }, 700); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FUNCTIONAL CODE BLOCK
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPPORTED_LANGS = ['javascript','python','html','css','json','typescript','bash','sql','markdown','plaintext'];

function insertCodeBlock() {
  const cbId = 'cb_' + Date.now();
  const html = `<div class="code-block-wrap" data-cbid="${cbId}" contenteditable="false">
  <div class="code-block-header">
    <select class="code-lang-select" onchange="onLangChange(this,'${cbId}')">
      ${SUPPORTED_LANGS.map(l => `<option value="${l}"${l==='javascript'?' selected':''}>${l}</option>`).join('')}
    </select>
    <span class="code-spacer"></span>
    <button class="code-run-btn" onclick="runCode('${cbId}')" title="Run (JS only)">‚ñ∂ Run</button>
    <button class="code-copy-btn" onclick="copyCode('${cbId}')">Copy</button>
  </div>
  <textarea class="code-editor-area" id="codearea_${cbId}" placeholder="// Write code here‚Ä¶" onkeydown="codeKeydown(event,this)" oninput="onCodeInput('${cbId}')"></textarea>
  <div class="code-output" id="codeout_${cbId}">
    <div class="code-output-label">Output</div>
    <pre id="codepre_${cbId}"></pre>
  </div>
</div><p><br></p>`;

  edFocus();
  document.execCommand('insertHTML', false, html);
  setTimeout(() => {
    const ta = document.getElementById('codearea_' + cbId);
    if (ta) { ta.focus(); initCodeBlockHighlight(cbId); }
  }, 50);
}

function codeKeydown(e, ta) {
  if (e.key === 'Tab') {
    e.preventDefault();
    const start = ta.selectionStart, end = ta.selectionEnd;
    ta.value = ta.value.substring(0, start) + '  ' + ta.value.substring(end);
    ta.selectionStart = ta.selectionEnd = start + 2;
  }
}

function onCodeInput(cbId) {
  // Save via editor content change
  if (activeNote) {
    notes[activeNote].content = document.getElementById('editor').innerHTML;
    debounceSave();
  }
}

function onLangChange(sel, cbId) {
  const lang = sel.value;
  const runBtn = sel.closest('.code-block-wrap')?.querySelector('.code-run-btn');
  if (runBtn) runBtn.style.display = lang === 'javascript' ? 'flex' : 'none';
}

function initCodeBlockHighlight(cbId) {
  // nothing extra needed for textarea-based editing
  const ta = document.getElementById('codearea_' + cbId);
  if (!ta) return;
  const sel = ta.closest('.code-block-wrap')?.querySelector('.code-lang-select');
  if (sel) onLangChange(sel, cbId);
}

function initAllCodeBlocks() {
  document.querySelectorAll('.code-block-wrap').forEach(wrap => {
    const cbId = wrap.dataset.cbid;
    if (cbId) {
      const sel = wrap.querySelector('.code-lang-select');
      if (sel) onLangChange(sel, cbId);
    }
  });
}

function runCode(cbId) {
  const ta = document.getElementById('codearea_' + cbId);
  const outEl = document.getElementById('codeout_' + cbId);
  const preEl = document.getElementById('codepre_' + cbId);
  if (!ta || !outEl || !preEl) return;

  const code = ta.value.trim();
  if (!code) { toast('Write some code first!'); return; }

  outEl.className = 'code-output show';
  preEl.textContent = '';

  const logs = [];
  const origConsole = { log: console.log, error: console.error, warn: console.warn, info: console.info };

  const capture = (...args) => {
    logs.push(args.map(a => {
      try { return typeof a === 'object' ? JSON.stringify(a, null, 2) : String(a); }
      catch { return String(a); }
    }).join(' '));
  };

  console.log = capture;
  console.error = capture;
  console.warn = capture;
  console.info = capture;

  try {
    const result = new Function(code)();
    console.log = origConsole.log;
    console.error = origConsole.error;
    console.warn = origConsole.warn;
    console.info = origConsole.info;

    let output = logs.join('\n');
    if (result !== undefined) output += (output ? '\n' : '') + '‚Üí ' + (typeof result === 'object' ? JSON.stringify(result, null, 2) : String(result));
    preEl.textContent = output || '(no output)';
    outEl.className = 'code-output show';
    toast('Ran ‚úì', 'green');
  } catch(err) {
    console.log = origConsole.log;
    console.error = origConsole.error;
    console.warn = origConsole.warn;
    console.info = origConsole.info;
    preEl.textContent = '‚ö† ' + err.message;
    outEl.className = 'code-output show error';
  }
}

function copyCode(cbId) {
  const ta = document.getElementById('codearea_' + cbId);
  if (!ta) return;
  navigator.clipboard.writeText(ta.value).then(() => toast('Copied!')).catch(() => {
    const el = document.createElement('textarea');
    el.value = ta.value; document.body.appendChild(el);
    el.select(); document.execCommand('copy'); document.body.removeChild(el);
    toast('Copied!');
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FUNCTIONAL KANBAN BOARD
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const KANBAN_COLORS = ['#6b7280','#dc2626','#d4580a','#ca8a04','#16a34a','#2563eb','#7c3aed'];
const COL_COLORS = ['#2563eb','#ca8a04','#16a34a','#7c3aed','#dc2626','#0891b2'];

function insertKanban() {
  const kbId = 'kb_' + Date.now();
  const defaultCols = [
    { id: 'col_1', name: 'To Do', color: '#6b7280', cards: [
      { id: 'card_1', title: 'Research topic', desc: '', color: '#6b7280' },
      { id: 'card_2', title: 'Plan outline', desc: '', color: '#6b7280' }
    ]},
    { id: 'col_2', name: 'In Progress', color: '#ca8a04', cards: [
      { id: 'card_3', title: 'Draft content', desc: 'Working on this now', color: '#ca8a04' }
    ]},
    { id: 'col_3', name: 'Done', color: '#16a34a', cards: [
      { id: 'card_4', title: 'Setup project', desc: '', color: '#16a34a' }
    ]}
  ];
  const html = renderKanbanHTML(kbId, 'My Board', defaultCols);
  edFocus();
  document.execCommand('insertHTML', false, html + '<p><br></p>');
  setTimeout(() => attachKanbanEvents(kbId), 80);
}

function renderKanbanHTML(kbId, boardTitle, cols) {
  const colsHtml = cols.map((col, ci) => `
    <div class="kanban-col" id="kcol_${col.id}" data-colid="${col.id}" data-kbid="${kbId}">
      <div class="kanban-col-header">
        <div class="kanban-col-dot" style="background:${col.color}"></div>
        <input class="kanban-col-name" value="${esc(col.name)}" style="color:${col.color}"
          onchange="onColNameChange('${kbId}','${col.id}',this.value)"
          onkeydown="if(event.key==='Enter')this.blur()">
        <span class="kanban-col-count">${col.cards.length}</span>
        <button class="kanban-col-del" onclick="deleteKanbanCol('${kbId}','${col.id}')" title="Delete column">‚úï</button>
      </div>
      <div class="kanban-cards" id="kcards_${col.id}"
        ondragover="kanbanDragOver(event,'${kbId}','${col.id}')"
        ondragenter="kanbanDragEnter(event,'${kbId}','${col.id}')"
        ondragleave="kanbanDragLeave(event,'${col.id}')"
        ondrop="kanbanDrop(event,'${kbId}','${col.id}')">
        ${col.cards.map(card => renderCardHTML(kbId, col.id, card)).join('')}
      </div>
      <button class="kanban-add-card" onclick="addKanbanCard('${kbId}','${col.id}')">Ôºã Add card</button>
    </div>
  `).join('');

  return `<div class="kanban-wrap" data-kbid="${kbId}" contenteditable="false">
  <div class="kanban-header">
    <input class="kanban-board-title" value="${esc(boardTitle)}"
      onchange="onBoardTitleChange('${kbId}',this.value)"
      onkeydown="if(event.key==='Enter')this.blur()">
    <button class="kanban-add-col-btn" onclick="addKanbanCol('${kbId}')">Ôºã Column</button>
  </div>
  <div class="kanban-cols" id="kboard_${kbId}">${colsHtml}</div>
</div>`;
}

function renderCardHTML(kbId, colId, card) {
  return `<div class="kanban-card" id="kcard_${card.id}" 
    draggable="true"
    data-cardid="${card.id}" data-colid="${colId}" data-kbid="${kbId}"
    ondragstart="kanbanDragStart(event,'${kbId}','${colId}','${card.id}')"
    ondragend="kanbanDragEnd(event)">
    <div class="kanban-card-title">${esc(card.title)}</div>
    ${card.desc ? `<div class="kanban-card-desc">${esc(card.desc)}</div>` : ''}
    <div class="kanban-card-meta">
      <div class="kanban-card-tag" style="background:${card.color}22;color:${card.color};border:1px solid ${card.color}44;">
        ${getColName(kbId, colId) || '‚Äî'}
      </div>
      <div class="kanban-card-actions">
        <button class="kca-btn" onclick="editKanbanCard('${kbId}','${colId}','${card.id}')">Edit</button>
        <button class="kca-btn del" onclick="deleteKanbanCard('${kbId}','${colId}','${card.id}')">‚úï</button>
      </div>
    </div>
  </div>`;
}

function getKanbanData(kbId) {
  // Extract kanban state from DOM
  const board = document.getElementById('kboard_' + kbId);
  if (!board) return null;
  const cols = [];
  board.querySelectorAll('.kanban-col').forEach(colEl => {
    const colId = colEl.dataset.colid;
    const nameInput = colEl.querySelector('.kanban-col-name');
    const dotEl = colEl.querySelector('.kanban-col-dot');
    const cards = [];
    colEl.querySelectorAll('.kanban-card').forEach(cardEl => {
      const cardId = cardEl.dataset.cardid;
      const title = cardEl.querySelector('.kanban-card-title')?.textContent || '';
      const desc = cardEl.querySelector('.kanban-card-desc')?.textContent || '';
      const tagEl = cardEl.querySelector('.kanban-card-tag');
      const color = tagEl ? tagEl.style.color : '#6b7280';
      cards.push({ id: cardId, title, desc, color });
    });
    cols.push({
      id: colId,
      name: nameInput?.value || '',
      color: dotEl?.style.background || '#6b7280',
      cards
    });
  });
  return cols;
}

function getColName(kbId, colId) {
  const colEl = document.getElementById('kcol_' + colId);
  return colEl?.querySelector('.kanban-col-name')?.value || '';
}

// Drag and Drop
function kanbanDragStart(e, kbId, colId, cardId) {
  dragCard = { kbId, colId, cardId };
  const cardEl = document.getElementById('kcard_' + cardId);
  e.dataTransfer.effectAllowed = 'move';
  e.dataTransfer.setData('text/plain', cardId);
  setTimeout(() => { if (cardEl) cardEl.classList.add('dragging'); }, 0);
}

function kanbanDragEnd(e) {
  if (dragCard) {
    const cardEl = document.getElementById('kcard_' + dragCard.cardId);
    if (cardEl) cardEl.classList.remove('dragging');
  }
  // Remove all drag-over states
  document.querySelectorAll('.kanban-col.drag-over').forEach(el => el.classList.remove('drag-over'));
  document.querySelectorAll('.kanban-card-ghost').forEach(el => el.remove());
  dragCard = null;
}

function kanbanDragOver(e, kbId, colId) {
  e.preventDefault(); e.dataTransfer.dropEffect = 'move';
}
function kanbanDragEnter(e, kbId, colId) {
  e.preventDefault();
  document.querySelectorAll('.kanban-col.drag-over').forEach(el => el.classList.remove('drag-over'));
  document.getElementById('kcol_' + colId)?.classList.add('drag-over');
}
function kanbanDragLeave(e, colId) {
  const col = document.getElementById('kcol_' + colId);
  if (col && !col.contains(e.relatedTarget)) col.classList.remove('drag-over');
}

function kanbanDrop(e, kbId, toColId) {
  e.preventDefault();
  if (!dragCard) return;
  const { cardId, colId: fromColId } = dragCard;
  if (fromColId === toColId) {
    document.getElementById('kcol_' + toColId)?.classList.remove('drag-over');
    return;
  }

  // Get card data before removing
  const cardEl = document.getElementById('kcard_' + cardId);
  if (!cardEl) { document.getElementById('kcol_' + toColId)?.classList.remove('drag-over'); return; }

  const title = cardEl.querySelector('.kanban-card-title')?.textContent || '';
  const desc = cardEl.querySelector('.kanban-card-desc')?.textContent || '';
  const tagEl = cardEl.querySelector('.kanban-card-tag');
  const color = tagEl ? tagEl.style.color : '#6b7280';

  // Remove from source
  cardEl.remove();

  // Update count
  updateColCount(kbId, fromColId);

  // Add to destination
  const newCard = { id: cardId, title, desc, color };
  const newCardHtml = renderCardHTML(kbId, toColId, newCard);
  const destCards = document.getElementById('kcards_' + toColId);
  if (destCards) destCards.insertAdjacentHTML('beforeend', newCardHtml);

  // Update col name on card tag
  const movedCardEl = document.getElementById('kcard_' + cardId);
  if (movedCardEl) {
    const tagEl2 = movedCardEl.querySelector('.kanban-card-tag');
    if (tagEl2) tagEl2.textContent = getColName(kbId, toColId) || '‚Äî';
    movedCardEl.dataset.colid = toColId;
    movedCardEl.setAttribute('ondragstart', `kanbanDragStart(event,'${kbId}','${toColId}','${cardId}')`);
    movedCardEl.setAttribute('onclick', `editKanbanCard('${kbId}','${toColId}','${cardId}')`);
    const editBtn = movedCardEl.querySelector('.kca-btn:not(.del)');
    if (editBtn) editBtn.setAttribute('onclick', `editKanbanCard('${kbId}','${toColId}','${cardId}')`);
    const delBtn = movedCardEl.querySelector('.kca-btn.del');
    if (delBtn) delBtn.setAttribute('onclick', `deleteKanbanCard('${kbId}','${toColId}','${cardId}')`);
  }

  updateColCount(kbId, toColId);
  document.getElementById('kcol_' + toColId)?.classList.remove('drag-over');

  // Persist
  if (activeNote) { notes[activeNote].content = document.getElementById('editor').innerHTML; debounceSave(); }
  toast('Card moved ‚Üí');
}

function updateColCount(kbId, colId) {
  const colEl = document.getElementById('kcol_' + colId);
  if (!colEl) return;
  const count = colEl.querySelectorAll('.kanban-card').length;
  const countEl = colEl.querySelector('.kanban-col-count');
  if (countEl) countEl.textContent = count;
}

function addKanbanCard(kbId, colId) {
  const cardId = 'card_' + Date.now();
  // Open card modal
  openCardModal('New Card', kbId, colId, cardId, null, (cardData) => {
    const card = { id: cardId, ...cardData };
    const html = renderCardHTML(kbId, colId, card);
    const dest = document.getElementById('kcards_' + colId);
    if (dest) dest.insertAdjacentHTML('beforeend', html);
    updateColCount(kbId, colId);
    if (activeNote) { notes[activeNote].content = document.getElementById('editor').innerHTML; debounceSave(); }
  });
}

function editKanbanCard(kbId, colId, cardId) {
  const cardEl = document.getElementById('kcard_' + cardId);
  if (!cardEl) return;
  const title = cardEl.querySelector('.kanban-card-title')?.textContent || '';
  const desc = cardEl.querySelector('.kanban-card-desc')?.textContent || '';
  const tagEl = cardEl.querySelector('.kanban-card-tag');
  const color = tagEl ? tagEl.style.color : '#6b7280';

  openCardModal('Edit Card', kbId, colId, cardId, { title, desc, color }, (cardData) => {
    // Update the card element
    const titleEl = cardEl.querySelector('.kanban-card-title');
    if (titleEl) titleEl.textContent = cardData.title;
    let descEl = cardEl.querySelector('.kanban-card-desc');
    if (cardData.desc) {
      if (!descEl) {
        descEl = document.createElement('div');
        descEl.className = 'kanban-card-desc';
        titleEl.after(descEl);
      }
      descEl.textContent = cardData.desc;
    } else if (descEl) descEl.remove();
    if (tagEl) {
      tagEl.style.background = cardData.color + '22';
      tagEl.style.color = cardData.color;
      tagEl.style.borderColor = cardData.color + '44';
    }
    if (activeNote) { notes[activeNote].content = document.getElementById('editor').innerHTML; debounceSave(); }
  });
}

function deleteKanbanCard(kbId, colId, cardId) {
  const cardEl = document.getElementById('kcard_' + cardId);
  if (!cardEl) return;
  cardEl.remove();
  updateColCount(kbId, colId);
  if (activeNote) { notes[activeNote].content = document.getElementById('editor').innerHTML; debounceSave(); }
  toast('Card deleted');
}

function addKanbanCol(kbId) {
  const colId = 'col_' + Date.now();
  const color = COL_COLORS[document.querySelectorAll(`[data-kbid="${kbId}"] .kanban-col`).length % COL_COLORS.length];
  const col = { id: colId, name: 'New Column', color, cards: [] };
  const html = `<div class="kanban-col" id="kcol_${col.id}" data-colid="${col.id}" data-kbid="${kbId}">
    <div class="kanban-col-header">
      <div class="kanban-col-dot" style="background:${col.color}"></div>
      <input class="kanban-col-name" value="${esc(col.name)}" style="color:${col.color}"
        onchange="onColNameChange('${kbId}','${col.id}',this.value)"
        onkeydown="if(event.key==='Enter')this.blur()">
      <span class="kanban-col-count">0</span>
      <button class="kanban-col-del" onclick="deleteKanbanCol('${kbId}','${col.id}')">‚úï</button>
    </div>
    <div class="kanban-cards" id="kcards_${col.id}"
      ondragover="kanbanDragOver(event,'${kbId}','${col.id}')"
      ondragenter="kanbanDragEnter(event,'${kbId}','${col.id}')"
      ondragleave="kanbanDragLeave(event,'${col.id}')"
      ondrop="kanbanDrop(event,'${kbId}','${col.id}')"></div>
    <button class="kanban-add-card" onclick="addKanbanCard('${kbId}','${col.id}')">Ôºã Add card</button>
  </div>`;
  document.getElementById('kboard_' + kbId)?.insertAdjacentHTML('beforeend', html);
  if (activeNote) { notes[activeNote].content = document.getElementById('editor').innerHTML; debounceSave(); }
}

function deleteKanbanCol(kbId, colId) {
  const cards = document.querySelectorAll(`#kcards_${colId} .kanban-card`).length;
  if (cards > 0 && !confirm(`Delete column with ${cards} card(s)?`)) return;
  document.getElementById('kcol_' + colId)?.remove();
  if (activeNote) { notes[activeNote].content = document.getElementById('editor').innerHTML; debounceSave(); }
}

function onColNameChange(kbId, colId, newName) {
  // Update all cards in this col that show the col name
  document.querySelectorAll(`#kcards_${colId} .kanban-card-tag`).forEach(el => {
    el.textContent = newName;
  });
  if (activeNote) { notes[activeNote].content = document.getElementById('editor').innerHTML; debounceSave(); }
}

function onBoardTitleChange(kbId, newTitle) {
  if (activeNote) { notes[activeNote].content = document.getElementById('editor').innerHTML; debounceSave(); }
}

function attachKanbanEvents(kbId) {
  // Events are inline, but re-apply drag events after render
}

// Card Modal
function openCardModal(title, kbId, colId, cardId, existing, cb) {
  document.getElementById('cm-title').textContent = title;
  document.getElementById('cm-card-title').value = existing?.title || '';
  document.getElementById('cm-card-desc').value = existing?.desc || '';
  // Select color
  document.querySelectorAll('.cm-color-btn').forEach(btn => {
    btn.classList.toggle('sel', btn.dataset.color === (existing?.color || '#6b7280'));
  });
  cardModalCb = cb;
  document.getElementById('card-modal').classList.add('open');
  setTimeout(() => document.getElementById('cm-card-title').focus(), 50);
}
function closeCardModal() {
  document.getElementById('card-modal').classList.remove('open');
  cardModalCb = null;
}
function selectCardColor(btn) {
  document.querySelectorAll('.cm-color-btn').forEach(b => b.classList.remove('sel'));
  btn.classList.add('sel');
}
function saveCard() {
  const title = document.getElementById('cm-card-title').value.trim();
  if (!title) { document.getElementById('cm-card-title').focus(); return; }
  const desc = document.getElementById('cm-card-desc').value.trim();
  const colorBtn = document.querySelector('.cm-color-btn.sel');
  const color = colorBtn?.dataset.color || '#6b7280';
  closeCardModal();
  if (cardModalCb) cardModalCb({ title, desc, color });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  FORMAT / SLASH
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function edFocus() { document.getElementById('editor').focus(); }
function fmt(cmd) { document.execCommand(cmd, false, null); edFocus(); }
function fmtBlock(tag) { document.execCommand('formatBlock', false, tag); edFocus(); }
function doQuote() { document.execCommand('formatBlock', false, 'blockquote'); edFocus(); }
function doLink() {
  const sel = window.getSelection();
  if (!sel.toString()) return;
  const url = prompt('Enter URL:');
  if (url) document.execCommand('createLink', false, url);
}
function doWikilink() {
  openModal('Link to Note', 'Note title‚Ä¶', name => {
    if (!name.trim()) return;
    edFocus();
    document.execCommand('insertHTML', false,
      `<span class="wikilink" onclick="openByTitle('${esc(name)}')">${esc(name)}</span>&nbsp;`);
  });
}
function openByTitle(title) {
  const m = Object.values(notes).find(n => n.title.toLowerCase() === title.toLowerCase());
  if (m) { openNote(m.id); toast(`‚Üí ${title}`); }
  else toast(`Note "${title}" not found`);
}

let slashFiltered = [...SLASH_BLOCKS], slashFocus = 0, slashOpen = false;

function buildSlashList(list) {
  document.getElementById('slash-list').innerHTML = list.map((b, i) => `
    <div class="slash-item${i===slashFocus?' focus':''}" onclick="execSlash('${b.id}')">
      <span class="slash-icon">${b.icon}</span>
      <div><div class="slash-label">${b.label}</div><div class="slash-desc">${b.desc}</div></div>
    </div>`).join('');
}
function filterSlash(q) {
  slashFiltered = SLASH_BLOCKS.filter(b => b.label.toLowerCase().includes(q.toLowerCase()));
  slashFocus = 0; buildSlashList(slashFiltered);
}
function openSlash() {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  const rect = sel.getRangeAt(0).getBoundingClientRect();
  const m = document.getElementById('slash-menu');
  m.style.left = Math.max(8, rect.left) + 'px';
  m.style.top = (rect.bottom + 5) + 'px';
  m.classList.add('open'); slashOpen = true;
  document.getElementById('slash-search').value = '';
  slashFiltered = [...SLASH_BLOCKS]; slashFocus = 0; buildSlashList(slashFiltered);
  document.getElementById('slash-search').focus();
  document.execCommand('delete', false, null);
}
function closeSlash() { document.getElementById('slash-menu').classList.remove('open'); slashOpen = false; }
function slashKeys(e) {
  if (e.key==='ArrowDown'){slashFocus=(slashFocus+1)%Math.max(1,slashFiltered.length);buildSlashList(slashFiltered);e.preventDefault();}
  else if(e.key==='ArrowUp'){slashFocus=(slashFocus-1+Math.max(1,slashFiltered.length))%Math.max(1,slashFiltered.length);buildSlashList(slashFiltered);e.preventDefault();}
  else if(e.key==='Enter'){if(slashFiltered[slashFocus])execSlash(slashFiltered[slashFocus].id);e.preventDefault();}
  else if(e.key==='Escape')closeSlash();
}
function execSlash(id) {
  closeSlash(); edFocus();
  const b = SLASH_BLOCKS.find(x => x.id === id);
  if (b) b.fn();
}
function editorKey(e) {
  if (e.key === '/' && !slashOpen) { setTimeout(openSlash, 30); return; }
  if (e.key === 'Escape') closeSlash();
  if (e.key === ' ' || e.key === 'Enter') checkMdTriggers();
}
function checkMdTriggers() {
  const sel = window.getSelection();
  if (!sel.rangeCount) return;
  const node = sel.getRangeAt(0).startContainer;
  const txt = (node.textContent||'').trim();
  const map = {'#':'h1','##':'h2','###':'h3','>':'blockquote','>>':'blockquote'};
  const tag = map[txt] || map[txt.slice(0,-1)];
  if (tag) { document.execCommand('formatBlock',false,tag); try{node.textContent='';}catch{} }
  if (txt==='-'||txt==='*') { document.execCommand('insertUnorderedList'); try{node.textContent='';}catch{} }
}

function showFmtBar() {
  const sel = window.getSelection();
  if (!sel||sel.isCollapsed||!sel.toString().trim()){hideFmtBar();return;}
  const tb = document.getElementById('fmt-bar');
  const rect = sel.getRangeAt(0).getBoundingClientRect();
  const tw = 440;
  let left = rect.left + rect.width/2 - tw/2;
  let top = rect.top - 46 + window.scrollY;
  left = Math.max(8, Math.min(innerWidth-tw-8, left));
  if (top < 8) top = rect.bottom + 8;
  tb.style.left = left+'px'; tb.style.top = top+'px'; tb.style.width = tw+'px';
  tb.classList.add('visible');
}
function hideFmtBar() { document.getElementById('fmt-bar').classList.remove('visible'); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  WORD COUNT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function updateWordCount() {
  const el = document.getElementById('editor');
  const txt = el.innerText||'';
  const w = txt.trim() ? txt.trim().split(/\s+/).length : 0;
  document.getElementById('wc-words').textContent = w.toLocaleString();
  document.getElementById('wc-chars').textContent = txt.length.toLocaleString();
  document.getElementById('meta-wc').textContent = `${w} word${w!==1?'s':''}`;
  if (activeNote) notes[activeNote]._wc = w;
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  DRAWING ENGINE ‚Äî GoodNotes feel
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function initCanvases() {
  mainCvs = document.getElementById('draw-canvas');
  mainCtx = mainCvs.getContext('2d');
  bgCvs = document.getElementById('bg-canvas');
  bgCtx = bgCvs.getContext('2d');
  overlayCvs = document.getElementById('overlay-canvas');
  overlayCtx = overlayCvs.getContext('2d');
  mixCvs = document.getElementById('mixed-canvas');
  mixCtx = mixCvs.getContext('2d');
  mixBgCvs = document.getElementById('mixed-bg-canvas');
  mixBgCtx = mixBgCvs.getContext('2d');

  const ca = document.getElementById('canvas-area');
  const mca = document.getElementById('mixed-canvas-area');

  new ResizeObserver(() => { resizeCanvas(mainCvs, ca); resizeCanvas(bgCvs, ca); resizeCanvas(overlayCvs, ca); redrawMain(); redrawBg(); }).observe(ca);
  new ResizeObserver(() => { resizeCanvas(mixCvs, mca); resizeCanvas(mixBgCvs, mca); redrawMix(); redrawMixBg(); }).observe(mca);

  resizeAllCanvases();
  setupPointerEvents(ca, 'main');
  setupPointerEvents(mca, 'mixed');
  setupPinch(ca, 'main');
  setupPinch(mca, 'mixed');

  ca.addEventListener('wheel', e => {
    e.preventDefault();
    if (e.ctrlKey || e.metaKey) {
      const vp = getVP();
      const rect = ca.getBoundingClientRect();
      zoomAtPt(e.clientX - rect.left, e.clientY - rect.top, e.deltaY < 0 ? 1.1 : 1/1.1, 'main');
    } else {
      const vp = getVP();
      vp.x -= e.deltaX; vp.y -= e.deltaY;
      redrawMain(); redrawBg(); updateHUD();
    }
  }, { passive: false });
}

function resizeCanvas(cvs, wrap) {
  if (!cvs || !wrap) return;
  const { width: w, height: h } = wrap.getBoundingClientRect();
  if (w > 0 && h > 0) { cvs.width = w; cvs.height = h; }
}
function resizeAllCanvases() {
  const ca = document.getElementById('canvas-area');
  const mca = document.getElementById('mixed-canvas-area');
  if (ca) { resizeCanvas(mainCvs, ca); resizeCanvas(bgCvs, ca); resizeCanvas(overlayCvs, ca); }
  if (mca) { resizeCanvas(mixCvs, mca); resizeCanvas(mixBgCvs, mca); }
  redrawMain(); redrawBg(); redrawMix(); redrawMixBg();
}

function getVP(which='main') {
  if (!activeNote) return { x: 0, y: 0, scale: 1 };
  const key = activeNote + '_' + which;
  if (!viewports[key]) viewports[key] = { x: 0, y: 0, scale: 1 };
  return viewports[key];
}

function setupPinch(wrap, vk) {
  let lastDist = null, lastMX = 0, lastMY = 0;
  wrap.addEventListener('touchstart', e => { if (e.touches.length === 2) { lastDist = null; e.preventDefault(); } }, { passive: false });
  wrap.addEventListener('touchmove', e => {
    if (e.touches.length === 2) {
      e.preventDefault();
      const t0 = e.touches[0], t1 = e.touches[1];
      const rect = wrap.getBoundingClientRect();
      const dx = t0.clientX - t1.clientX, dy = t0.clientY - t1.clientY;
      const dist = Math.sqrt(dx*dx + dy*dy);
      const mx = (t0.clientX + t1.clientX)/2 - rect.left;
      const my = (t0.clientY + t1.clientY)/2 - rect.top;
      if (lastDist !== null) {
        zoomAtPt(mx, my, dist / lastDist, vk);
        const vp = getVP(vk);
        vp.x += mx - lastMX; vp.y += my - lastMY;
      }
      lastDist = dist; lastMX = mx; lastMY = my;
      if (vk === 'main') { redrawMain(); redrawBg(); updateHUD(); } else { redrawMix(); redrawMixBg(); }
    }
  }, { passive: false });
  wrap.addEventListener('touchend', e => { if (e.touches.length < 2) lastDist = null; });
}

function zoomAtPt(sx, sy, factor, vk='main') {
  const vp = getVP(vk);
  const minS = 0.05, maxS = 20;
  const ns = Math.max(minS, Math.min(maxS, vp.scale * factor));
  const af = ns / vp.scale;
  vp.x = sx - af * (sx - vp.x);
  vp.y = sy - af * (sy - vp.y);
  vp.scale = ns;
  if (vk === 'main') { document.getElementById('hud-zoom').textContent = Math.round(ns*100)+'%'; updateHUD(); }
}

function zoomStep(d) {
  const ca = document.getElementById('canvas-area');
  const r = ca.getBoundingClientRect();
  zoomAtPt(r.width/2, r.height/2, d > 0 ? 1 + d : 1/(1-d), 'main');
  redrawMain(); redrawBg();
}

function resetViewport() {
  if (!activeNote) return;
  const vp = getVP('main');
  vp.x = 0; vp.y = 0; vp.scale = 1;
  document.getElementById('hud-zoom').textContent = '100%';
  redrawMain(); redrawBg(); updateHUD();
  toast('View reset');
}

function fitToContent() {
  if (!activeNote || !drawData[activeNote]) return;
  const allStrokes = drawData[activeNote].pages.flat();
  if (!allStrokes.length) { resetViewport(); return; }
  let x1=Infinity,y1=Infinity,x2=-Infinity,y2=-Infinity;
  allStrokes.forEach(s => {
    if (s.pts) s.pts.forEach(p => { x1=Math.min(x1,p.x);y1=Math.min(y1,p.y);x2=Math.max(x2,p.x);y2=Math.max(y2,p.y); });
    if (s.start) { x1=Math.min(x1,s.start.x,s.end.x);y1=Math.min(y1,s.start.y,s.end.y);x2=Math.max(x2,s.start.x,s.end.x);y2=Math.max(y2,s.start.y,s.end.y); }
    if (s.x != null) { x1=Math.min(x1,s.x);y1=Math.min(y1,s.y);x2=Math.max(x2,s.x+(s.w||0));y2=Math.max(y2,s.y+(s.h||0)); }
  });
  const ca = document.getElementById('canvas-area');
  const ww = ca.clientWidth, wh = ca.clientHeight;
  const pad = 60;
  const s = Math.min((ww-pad*2)/Math.max(x2-x1,1), (wh-pad*2)/Math.max(y2-y1,1), 2);
  const vp = getVP('main');
  vp.scale = s;
  vp.x = (ww - (x2-x1)*s)/2 - x1*s;
  vp.y = (wh - (y2-y1)*s)/2 - y1*s;
  document.getElementById('hud-zoom').textContent = Math.round(s*100)+'%';
  redrawMain(); redrawBg(); updateHUD();
  toast('Fitted ‚úì', 'accent');
}

function updateHUD() {
  if (!activeNote) return;
  const vp = getVP('main');
  document.getElementById('hud-zoom').textContent = Math.round(vp.scale*100)+'%';
  const strokeCount = drawData[activeNote]?.pages?.[drawData[activeNote].page||0]?.length || 0;
  document.getElementById('hud-strokes').textContent = strokeCount;
  document.getElementById('hud-size').textContent = drawSize + 'px';
  document.getElementById('hud-tool').textContent = drawTool.charAt(0).toUpperCase() + drawTool.slice(1);
}

// ‚îÄ‚îÄ‚îÄ POINTER EVENTS (Palm rejection + pressure) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setupPointerEvents(wrap, vk) {
  wrap.addEventListener('pointerdown', e => {
    e.preventDefault();
    activePointers.set(e.pointerId, { x: e.clientX, y: e.clientY, type: e.pointerType, w: e.width||1, h: e.height||1 });

    // Palm rejection: large touch area = palm
    if (palmOn && e.pointerType === 'touch') {
      if (e.width > 40 || e.height > 40) { activePointers.delete(e.pointerId); return; }
      // If stylus already drawing, ignore additional touches
      if (drawingPointerId !== null) {
        const dp = activePointers.get(drawingPointerId);
        if (dp && dp.type === 'pen') { activePointers.delete(e.pointerId); return; }
      }
    }

    // 2-finger pan (touch)
    const touches = [...activePointers.values()].filter(p => p.type === 'touch');
    if (touches.length >= 2) {
      if (isDrawing && drawingPointerId) endDraw(e, vk);
      drawingPointerId = null; return;
    }

    if (drawTool === 'pan') {
      isPanning = true;
      const vp = getVP(vk);
      panStart = { x: e.clientX, y: e.clientY };
      panVpStart = { x: vp.x, y: vp.y };
      drawingPointerId = e.pointerId;
      try { wrap.querySelector('#draw-canvas, #mixed-canvas, canvas')?.setPointerCapture?.(e.pointerId); } catch {}
      return;
    }

    drawingPointerId = e.pointerId;
    try { 
      const cvs = vk === 'main' ? mainCvs : mixCvs;
      cvs?.setPointerCapture(e.pointerId);
    } catch {}
    startDraw(e, vk);
  }, { passive: false });

  wrap.addEventListener('pointermove', e => {
    e.preventDefault();
    if (activePointers.has(e.pointerId)) {
      activePointers.set(e.pointerId, { ...activePointers.get(e.pointerId), x: e.clientX, y: e.clientY });
    }

    // Update custom cursors
    if (drawTool === 'eraser' || drawTool === 'scribble') {
      const rect = wrap.getBoundingClientRect();
      const cx = e.clientX - rect.left, cy = e.clientY - rect.top;
      const cursId = drawTool === 'eraser' ? 'eraser-cursor' : 'scribble-cursor';
      const curs = document.getElementById(cursId);
      if (curs) { curs.style.left = cx+'px'; curs.style.top = cy+'px'; curs.style.display = 'block'; }
    }

    if (isPanning && e.pointerId === drawingPointerId) {
      const vp = getVP(vk);
      vp.x = panVpStart.x + (e.clientX - panStart.x);
      vp.y = panVpStart.y + (e.clientY - panStart.y);
      if (vk === 'main') { redrawMain(); redrawBg(); updateHUD(); } else { redrawMix(); redrawMixBg(); }
      return;
    }
    if (!isDrawing || e.pointerId !== drawingPointerId) return;
    moveDraw(e, vk);
  }, { passive: false });

  const endHandler = e => {
    e.preventDefault();
    activePointers.delete(e.pointerId);
    ['eraser-cursor','scribble-cursor'].forEach(id => {
      const c = document.getElementById(id); if (c) c.style.display = 'none';
    });
    if (isPanning && e.pointerId === drawingPointerId) {
      isPanning = false; drawingPointerId = null;
      const ca = document.getElementById('canvas-area');
      ca.classList.remove('panning'); return;
    }
    if (e.pointerId === drawingPointerId) {
      endDraw(e, vk); drawingPointerId = null;
    }
  };

  wrap.addEventListener('pointerup', endHandler, { passive: false });
  wrap.addEventListener('pointercancel', endHandler, { passive: false });
  wrap.addEventListener('pointerleave', () => {
    ['eraser-cursor','scribble-cursor'].forEach(id => {
      const c = document.getElementById(id); if (c) c.style.display = 'none';
    });
  });
}

function screenToWorld(sx, sy, vk='main') {
  const vp = getVP(vk);
  return { x: (sx - vp.x) / vp.scale, y: (sy - vp.y) / vp.scale };
}

function getPt(e, vk='main') {
  const wrap = document.getElementById(vk==='main'?'canvas-area':'mixed-canvas-area');
  const r = wrap.getBoundingClientRect();
  return screenToWorld(e.clientX - r.left, e.clientY - r.top, vk);
}

// GoodNotes-style pressure ‚Üí line width
function getPressureWidth(e, basePx) {
  const p = (e.pressure && e.pressure > 0 && e.pointerType === 'pen') ? e.pressure : 0.5;
  const v = e._velocity || 0;
  // Width varies with pressure and inversely with velocity (fast strokes = thinner)
  const velocityFactor = Math.max(0.4, 1 - v * 0.003);
  return Math.max(0.5, basePx * p * velocityFactor * 1.8);
}

let lastPt = null, lastTime = 0;

function startDraw(e, vk) {
  if (!activeNote) return;
  isDrawing = true;
  const pt = getPt(e, vk);
  lastPt = pt; lastTime = Date.now();

  if (drawTool === 'scribble') {
    scribblePts = [pt];
    currentStroke = { tool: 'scribble', pts: [pt] };
    return;
  }
  if (drawTool === 'text') {
    const txt = prompt('Enter text:');
    if (txt) pushStroke({ tool: 'text', x: pt.x, y: pt.y, text: txt, color: drawColor, size: drawSize*4+14, font: 'serif' }, vk);
    isDrawing = false; return;
  }
  if (drawTool === 'eraser') {
    currentStroke = { tool: 'eraser', pts: [pt], size: drawSize * 8 };
    return;
  }
  if (['pen','marker','highlighter'].includes(drawTool)) {
    const lw = drawTool === 'highlighter' ? drawSize * 8 :
               drawTool === 'marker' ? drawSize * 3.5 :
               getPressureWidth(e, drawSize);
    currentStroke = {
      tool: drawTool, pts: [pt],
      widths: [lw],
      color: drawColor,
      opacity: drawTool === 'highlighter' ? 0.32 : drawTool === 'marker' ? 0.65 : 1
    };
    return;
  }
  // Shape tools
  startPt = pt;
  currentStroke = { tool: drawTool, start: pt, end: pt, color: drawColor, size: drawSize };
}

function moveDraw(e, vk) {
  if (!isDrawing || !currentStroke) return;
  const pt = getPt(e, vk);
  const now = Date.now();
  const dt = now - lastTime || 1;
  const dist = lastPt ? Math.hypot(pt.x - lastPt.x, pt.y - lastPt.y) : 0;
  const velocity = dist / dt * 16; // px/frame approx
  e._velocity = velocity;
  lastPt = pt; lastTime = now;

  const vp = getVP(vk);
  const ctx = vk === 'main' ? mainCtx : mixCtx;
  const cvs = vk === 'main' ? mainCvs : mixCvs;

  if (currentStroke.tool === 'scribble') {
    scribblePts.push(pt);
    currentStroke.pts.push(pt);
    // Visual feedback
    const oc = vk === 'main' ? overlayCtx : mixCtx;
    if (oc) {
      const oCvs = vk === 'main' ? overlayCvs : mixCvs;
      oc.clearRect(0, 0, oCvs.width, oCvs.height);
      oc.save();
      oc.translate(vp.x, vp.y); oc.scale(vp.scale, vp.scale);
      oc.strokeStyle = 'rgba(220,38,38,0.35)';
      oc.lineWidth = 20/vp.scale; oc.lineCap = 'round'; oc.lineJoin = 'round';
      oc.beginPath(); scribblePts.forEach((p,i) => i===0?oc.moveTo(p.x,p.y):oc.lineTo(p.x,p.y));
      oc.stroke(); oc.restore();
    }
    clearTimeout(scribbleTimer);
    scribbleTimer = setTimeout(() => doScribbleErase(vk), 350);
    return;
  }

  if (['pen','marker','highlighter','eraser'].includes(currentStroke.tool)) {
    const lw = currentStroke.tool === 'eraser' ? currentStroke.size :
               currentStroke.tool === 'highlighter' ? currentStroke.widths?.[0] || drawSize*8 :
               currentStroke.tool === 'marker' ? currentStroke.widths?.[0] || drawSize*3.5 :
               getPressureWidth(e, drawSize);
    if (currentStroke.widths) currentStroke.widths.push(lw);
    currentStroke.pts.push(pt);

    ctx.save();
    ctx.translate(vp.x, vp.y); ctx.scale(vp.scale, vp.scale);
    applyStyle(currentStroke, ctx, lw);

    const pts = currentStroke.pts;
    if (pts.length >= 3) {
      const i = pts.length - 1;
      const p0 = pts[i-2], p1 = pts[i-1], p2 = pts[i];
      const w0 = currentStroke.widths?.[i-2] || lw;
      const w1 = currentStroke.widths?.[i-1] || lw;
      const w2 = currentStroke.widths?.[i] || lw;

      if (currentStroke.tool === 'pen') {
        // Variable width pen - draw tapered segment
        ctx.lineWidth = (w1 + w2) / 2;
        ctx.beginPath();
        const mx1 = (p0.x+p1.x)/2, my1 = (p0.y+p1.y)/2;
        const mx2 = (p1.x+p2.x)/2, my2 = (p1.y+p2.y)/2;
        ctx.moveTo(mx1, my1);
        ctx.quadraticCurveTo(p1.x, p1.y, mx2, my2);
        ctx.stroke();
      } else {
        ctx.lineWidth = w1;
        ctx.beginPath();
        ctx.moveTo(p1.x, p1.y); ctx.lineTo(p2.x, p2.y); ctx.stroke();
      }
    } else if (pts.length === 2) {
      ctx.lineWidth = lw;
      ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(pts[1].x, pts[1].y); ctx.stroke();
    }
    ctx.restore();
  } else {
    // Shape preview on overlay
    currentStroke.end = pt;
    if (vk === 'main') {
      overlayCtx.clearRect(0, 0, overlayCvs.width, overlayCvs.height);
      overlayCtx.save();
      overlayCtx.translate(vp.x, vp.y); overlayCtx.scale(vp.scale, vp.scale);
      drawShapeStroke(currentStroke, overlayCtx, true);
      overlayCtx.restore();
    }
  }
}

function endDraw(e, vk) {
  if (!isDrawing) return;
  isDrawing = false;
  if (vk === 'main') overlayCtx.clearRect(0, 0, overlayCvs.width, overlayCvs.height);

  if (currentStroke?.tool === 'scribble') {
    clearTimeout(scribbleTimer);
    doScribbleErase(vk);
    currentStroke = null; scribblePts = [];
    return;
  }
  if (!currentStroke) return;

  if (!['pen','marker','highlighter','eraser'].includes(currentStroke.tool)) {
    currentStroke.end = getPt(e, vk);
  }

  // Taper pen stroke ends
  if (currentStroke.tool === 'pen' && currentStroke.pts.length > 4) {
    const ws = currentStroke.widths;
    if (ws && ws.length > 2) {
      // Taper start and end
      ws[0] = ws[0] * 0.1;
      ws[1] = ws[1] * 0.5;
      ws[ws.length-1] = ws[ws.length-1] * 0.1;
      ws[ws.length-2] = ws[ws.length-2] * 0.5;
    }
  }

  pushStroke(currentStroke, vk);
  currentStroke = null; startPt = null;
  if (vk === 'main') { redrawMain(); updateHUD(); } else redrawMix();
}

// ‚îÄ‚îÄ‚îÄ SCRIBBLE ERASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doScribbleErase(vk) {
  if (scribblePts.length < 6) return;
  const xs = scribblePts.map(p=>p.x), ys = scribblePts.map(p=>p.y);
  let reversals = 0;
  const win = 5;
  for (let i = win; i < xs.length - win; i++) {
    if ((xs[i]-xs[i-win]) * (xs[i+win]-xs[i]) < -30) reversals++;
    if ((ys[i]-ys[i-win]) * (ys[i+win]-ys[i]) < -30) reversals++;
  }

  if (reversals >= 3) {
    const x1=Math.min(...xs)-15, y1=Math.min(...ys)-15;
    const x2=Math.max(...xs)+15, y2=Math.max(...ys)+15;

    if (!activeNote || !drawData[activeNote]) return;
    const d = drawData[activeNote];
    const erased = [];
    d.pages = d.pages.map(pg => pg.filter(s => {
      if (strokeInBox(s, x1, y1, x2, y2)) { erased.push(s); return false; }
      return true;
    }));

    if (erased.length) {
      undoStacks[activeNote].push({ type:'scribble_erase', erased, page: d.page||0 });
      redoStacks[activeNote] = [];
      debounceSave();
      if (vk === 'main') { redrawMain(); updateHUD(); } else redrawMix();
      toast(`Erased ${erased.length} stroke${erased.length>1?'s':''}`, 'accent');
    }
  }

  // Clear overlay
  if (vk === 'main') overlayCtx.clearRect(0, 0, overlayCvs.width, overlayCvs.height);
  scribblePts = [];
}

function strokeInBox(s, x1, y1, x2, y2) {
  if (s.pts) return s.pts.some(p => p.x>=x1&&p.x<=x2&&p.y>=y1&&p.y<=y2);
  if (s.start) return !(Math.max(s.start.x,s.end.x)<x1||Math.min(s.start.x,s.end.x)>x2||Math.max(s.start.y,s.end.y)<y1||Math.min(s.start.y,s.end.y)>y2);
  if (s.x!=null) return !(s.x>x2||s.x+(s.w||0)<x1||s.y>y2||s.y+(s.h||0)<y1);
  return false;
}

// ‚îÄ‚îÄ‚îÄ PUSH / UNDO / REDO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function pushStroke(stroke, vk='main') {
  if (!activeNote) return;
  const d = drawData[activeNote]; const p = d.page||0;
  if (!d.pages[p]) d.pages[p] = [];
  d.pages[p].push(stroke);
  undoStacks[activeNote].push({ type:'stroke', stroke, page:p });
  redoStacks[activeNote] = [];
  notes[activeNote].hasDrawing = true;
  debounceSave();
}

function undoDraw() {
  if (!activeNote) return;
  const st = undoStacks[activeNote];
  if (!st?.length) { toast('Nothing to undo'); return; }
  const act = st.pop();
  redoStacks[activeNote].push(act);
  if (act.type === 'stroke') {
    const pg = drawData[activeNote].pages[act.page];
    const idx = pg ? pg.lastIndexOf(act.stroke) : -1;
    if (idx !== -1) pg.splice(idx, 1);
  } else if (act.type === 'scribble_erase') {
    if (!drawData[activeNote].pages[act.page]) drawData[activeNote].pages[act.page] = [];
    drawData[activeNote].pages[act.page].push(...act.erased);
  }
  redrawMain(); updateHUD(); debounceSave();
}

function redoDraw() {
  if (!activeNote) return;
  const rs = redoStacks[activeNote];
  if (!rs?.length) { toast('Nothing to redo'); return; }
  const act = rs.pop();
  undoStacks[activeNote].push(act);
  if (act.type === 'stroke') {
    const p = act.page;
    if (!drawData[activeNote].pages[p]) drawData[activeNote].pages[p] = [];
    drawData[activeNote].pages[p].push(act.stroke);
  } else if (act.type === 'scribble_erase') {
    const pg = drawData[activeNote].pages[act.page];
    if (pg) act.erased.forEach(s => { const i = pg.indexOf(s); if (i!==-1) pg.splice(i,1); });
  }
  redrawMain(); updateHUD(); debounceSave();
}

function clearPage() {
  if (!activeNote || !confirm('Clear this page?')) return;
  const d = drawData[activeNote]; const p = d.page||0;
  undoStacks[activeNote].push({ type:'scribble_erase', erased:[...(d.pages[p]||[])], page:p });
  d.pages[p] = []; redoStacks[activeNote] = [];
  redrawMain(); updateHUD(); debounceSave(); toast('Page cleared');
}

// ‚îÄ‚îÄ‚îÄ REDRAW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function redrawMain() {
  if (!mainCvs || !mainCtx) return;
  const vp = getVP('main');
  mainCtx.clearRect(0, 0, mainCvs.width, mainCvs.height);
  if (!activeNote || !drawData[activeNote]) return;
  const d = drawData[activeNote]; const p = d.page||0;
  mainCtx.save();
  mainCtx.translate(vp.x, vp.y); mainCtx.scale(vp.scale, vp.scale);
  (d.pages[p]||[]).forEach(s => drawStroke(s, mainCtx, vp.scale));
  mainCtx.restore();
}

function redrawMix() {
  if (!mixCvs || !mixCtx) return;
  const vp = getVP('mixed');
  mixCtx.clearRect(0, 0, mixCvs.width, mixCvs.height);
  if (!activeNote || !drawData[activeNote]) return;
  const d = drawData[activeNote]; const p = d.page||0;
  mixCtx.save();
  mixCtx.translate(vp.x, vp.y); mixCtx.scale(vp.scale, vp.scale);
  (d.pages[p]||[]).forEach(s => drawStroke(s, mixCtx, vp.scale));
  mixCtx.restore();
}

function redrawBg() {
  if (!bgCvs || !bgCtx) return;
  const w = bgCvs.width, h = bgCvs.height;
  bgCtx.clearRect(0, 0, w, h);

  // Read current theme colors from CSS variables
  const style = getComputedStyle(document.documentElement);
  const paperColor = style.getPropertyValue('--canvas-paper').trim() || '#fffffe';
  const gridColor  = style.getPropertyValue('--canvas-grid').trim()  || 'rgba(0,0,0,0.055)';
  const linesColor = style.getPropertyValue('--canvas-lines').trim() || 'rgba(0,0,0,0.07)';
  const dotsColor  = style.getPropertyValue('--canvas-dots').trim()  || 'rgba(0,0,0,0.12)';
  const marginColor= style.getPropertyValue('--canvas-margin').trim()|| 'rgba(212,88,10,0.15)';

  bgCtx.fillStyle = paperColor;
  bgCtx.fillRect(0, 0, w, h);
  const vp = getVP('main');
  if (currentBg === 'plain') return;

  const gridPx = 28 * vp.scale;
  const ox = ((vp.x % gridPx) + gridPx) % gridPx;
  const oy = ((vp.y % gridPx) + gridPx) % gridPx;

  bgCtx.save();
  if (currentBg === 'grid') {
    bgCtx.strokeStyle = gridColor; bgCtx.lineWidth = 1;
    for (let x = ox-gridPx; x <= w+gridPx; x += gridPx) { bgCtx.beginPath();bgCtx.moveTo(x,0);bgCtx.lineTo(x,h);bgCtx.stroke(); }
    for (let y = oy-gridPx; y <= h+gridPx; y += gridPx) { bgCtx.beginPath();bgCtx.moveTo(0,y);bgCtx.lineTo(w,y);bgCtx.stroke(); }
  } else if (currentBg === 'lined') {
    const lh = 32 * vp.scale;
    const loy = ((vp.y % lh) + lh) % lh;
    bgCtx.strokeStyle = linesColor; bgCtx.lineWidth = 1;
    for (let y = loy-lh; y <= h+lh; y += lh) { bgCtx.beginPath();bgCtx.moveTo(0,y);bgCtx.lineTo(w,y);bgCtx.stroke(); }
    const mx = 80 * vp.scale + vp.x;
    bgCtx.strokeStyle = marginColor; bgCtx.lineWidth = 1.5;
    bgCtx.beginPath();bgCtx.moveTo(mx,0);bgCtx.lineTo(mx,h);bgCtx.stroke();
  } else if (currentBg === 'dots') {
    bgCtx.fillStyle = dotsColor;
    for (let x=ox-gridPx; x<=w+gridPx; x+=gridPx) for (let y=oy-gridPx; y<=h+gridPx; y+=gridPx) {
      bgCtx.beginPath();bgCtx.arc(x,y,1.2,0,Math.PI*2);bgCtx.fill();
    }
  }
  bgCtx.restore();
}

function redrawMixBg() {
  if (!mixBgCvs || !mixBgCtx) return;
  const w = mixBgCvs.width, h = mixBgCvs.height;
  const style = getComputedStyle(document.documentElement);
  const paperColor = style.getPropertyValue('--canvas-paper').trim() || '#fffffe';
  const linesColor = style.getPropertyValue('--canvas-lines').trim() || 'rgba(0,0,0,0.07)';
  mixBgCtx.clearRect(0, 0, w, h);
  mixBgCtx.fillStyle = paperColor; mixBgCtx.fillRect(0, 0, w, h);
  mixBgCtx.strokeStyle = linesColor; mixBgCtx.lineWidth = 1;
  for (let y=28; y<h; y+=28) { mixBgCtx.beginPath();mixBgCtx.moveTo(0,y);mixBgCtx.lineTo(w,y);mixBgCtx.stroke(); }
}

// ‚îÄ‚îÄ‚îÄ STROKE RENDER ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawStroke(s, ctx, vpScale=1) {
  if (!s?.tool) return;
  ctx.save();

  if (s.tool === 'eraser') {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.strokeStyle = 'rgba(0,0,0,1)';
    ctx.lineWidth = s.size; ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    smoothPath(s.pts, ctx); ctx.restore(); return;
  }
  if (s.tool === 'highlighter') {
    ctx.globalCompositeOperation = 'multiply';
    ctx.strokeStyle = hexA(s.color, s.opacity||0.32);
    ctx.lineWidth = s.widths?.[0] || drawSize*8;
    ctx.lineCap = 'square'; ctx.lineJoin = 'bevel';
    flatPath(s.pts, ctx); ctx.restore(); return;
  }
  if (s.tool === 'marker') {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = hexA(s.color, s.opacity||0.65);
    ctx.lineWidth = s.widths?.[0] || drawSize*3.5;
    ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    smoothPath(s.pts, ctx); ctx.restore(); return;
  }
  if (s.tool === 'pen') {
    ctx.globalCompositeOperation = 'source-over';
    // Variable width pen stroke
    const pts = s.pts, ws = s.widths;
    if (!pts || pts.length < 2) { ctx.restore(); return; }
    ctx.lineCap = 'round'; ctx.lineJoin = 'round';
    for (let i = 1; i < pts.length; i++) {
      const lw = ws ? (ws[i-1]+ws[i])/2 : drawSize;
      ctx.strokeStyle = hexA(s.color, 1);
      ctx.lineWidth = Math.max(0.3, lw);
      ctx.beginPath();
      if (i === 1) {
        ctx.moveTo(pts[0].x, pts[0].y); ctx.lineTo(pts[1].x, pts[1].y);
      } else {
        const mx = (pts[i-1].x+pts[i].x)/2, my = (pts[i-1].y+pts[i].y)/2;
        ctx.moveTo((pts[i-2].x+pts[i-1].x)/2, (pts[i-2].y+pts[i-1].y)/2);
        ctx.quadraticCurveTo(pts[i-1].x, pts[i-1].y, mx, my);
      }
      ctx.stroke();
    }
    ctx.restore(); return;
  }
  if (s.tool === 'line') {
    ctx.strokeStyle = s.color; ctx.lineWidth = s.size; ctx.lineCap = 'round';
    ctx.beginPath();ctx.moveTo(s.start.x,s.start.y);ctx.lineTo(s.end.x,s.end.y);ctx.stroke();
  } else if (s.tool === 'rect') {
    ctx.strokeStyle = s.color; ctx.lineWidth = s.size;
    ctx.strokeRect(s.start.x,s.start.y,s.end.x-s.start.x,s.end.y-s.start.y);
  } else if (s.tool === 'circle') {
    ctx.strokeStyle = s.color; ctx.lineWidth = s.size;
    const rx=Math.abs(s.end.x-s.start.x)/2,ry=Math.abs(s.end.y-s.start.y)/2;
    if(rx>0&&ry>0){ctx.beginPath();ctx.ellipse((s.start.x+s.end.x)/2,(s.start.y+s.end.y)/2,rx,ry,0,0,Math.PI*2);ctx.stroke();}
  } else if (s.tool === 'arrow') {
    ctx.strokeStyle=s.color;ctx.lineWidth=s.size;ctx.lineCap='round';
    drawArrow(ctx,s.start,s.end);
  } else if (s.tool === 'text') {
    ctx.fillStyle = s.color;
    const ff = s.font==='serif'?'Lora,Georgia,serif':'Geist Mono,monospace';
    ctx.font = `${s.size}px ${ff}`;
    ctx.fillText(s.text, s.x, s.y);
  } else if (s.tool === 'raster' || s.tool === 'pdf_page') {
    if (s.img) {
      ctx.globalAlpha = 1; ctx.drawImage(s.img, s.x, s.y, s.w, s.h);
    } else if (s.dataURL) {
      const img = new Image();
      img.onload = () => { s.img = img; redrawMain(); };
      img.src = s.dataURL;
    }
  }
  ctx.restore();
}

function applyStyle(s, ctx, lw) {
  ctx.lineCap = 'round'; ctx.lineJoin = 'round';
  if (s.tool === 'eraser') {
    ctx.globalCompositeOperation = 'destination-out';
    ctx.strokeStyle = 'rgba(0,0,0,1)'; ctx.lineWidth = s.size;
  } else if (s.tool === 'highlighter') {
    ctx.globalCompositeOperation = 'multiply';
    ctx.strokeStyle = hexA(s.color, s.opacity||0.32); ctx.lineWidth = lw;
    ctx.lineCap = 'square';
  } else {
    ctx.globalCompositeOperation = 'source-over';
    ctx.strokeStyle = hexA(s.color, s.opacity||1); ctx.lineWidth = lw;
  }
}

function drawShapeStroke(s, ctx, preview=false) {
  if (!s?.start || !s?.end) return;
  ctx.save();
  ctx.strokeStyle = s.color; ctx.lineWidth = s.size; ctx.lineCap = 'round';
  if (preview) { ctx.globalAlpha = 0.6; ctx.setLineDash([6,4]); }
  if (s.tool==='line'){ctx.beginPath();ctx.moveTo(s.start.x,s.start.y);ctx.lineTo(s.end.x,s.end.y);ctx.stroke();}
  else if(s.tool==='rect'){ctx.strokeRect(s.start.x,s.start.y,s.end.x-s.start.x,s.end.y-s.start.y);}
  else if(s.tool==='circle'){const rx=Math.abs(s.end.x-s.start.x)/2,ry=Math.abs(s.end.y-s.start.y)/2;if(rx>0&&ry>0){ctx.beginPath();ctx.ellipse((s.start.x+s.end.x)/2,(s.start.y+s.end.y)/2,rx,ry,0,0,Math.PI*2);ctx.stroke();}}
  else if(s.tool==='arrow'){drawArrow(ctx,s.start,s.end);}
  ctx.restore();
}

function smoothPath(pts, ctx) {
  if (!pts||pts.length<2) return;
  ctx.beginPath(); ctx.moveTo(pts[0].x, pts[0].y);
  for (let i=1;i<pts.length-1;i++) {
    const mx=(pts[i].x+pts[i+1].x)/2, my=(pts[i].y+pts[i+1].y)/2;
    ctx.quadraticCurveTo(pts[i].x,pts[i].y,mx,my);
  }
  ctx.lineTo(pts[pts.length-1].x,pts[pts.length-1].y);
  ctx.stroke();
}

function flatPath(pts, ctx) {
  if (!pts||pts.length<2) return;
  ctx.beginPath(); ctx.moveTo(pts[0].x,pts[0].y);
  for (let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x,pts[i].y);
  ctx.stroke();
}

function drawArrow(ctx, a, b) {
  if (!a||!b) return;
  const ang=Math.atan2(b.y-a.y,b.x-a.x),hl=16;
  ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(b.x,b.y);ctx.lineTo(b.x-hl*Math.cos(ang-Math.PI/6),b.y-hl*Math.sin(ang-Math.PI/6));
  ctx.moveTo(b.x,b.y);ctx.lineTo(b.x-hl*Math.cos(ang+Math.PI/6),b.y-hl*Math.sin(ang+Math.PI/6));
  ctx.stroke();
}

function hexA(hex, a) {
  if (!hex||hex.length<7) return `rgba(26,25,22,${a})`;
  const r=parseInt(hex.slice(1,3),16),g=parseInt(hex.slice(3,5),16),b=parseInt(hex.slice(5,7),16);
  return `rgba(${r},${g},${b},${a})`;
}

// ‚îÄ‚îÄ‚îÄ TOOL CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function setTool(t) {
  drawTool = t;
  document.querySelectorAll('.tool-btn[id^="tool-"]').forEach(b => b.classList.remove('active'));
  document.getElementById('tool-'+t)?.classList.add('active');
  ['pen','hl','erase','pan'].forEach(x => {
    document.getElementById('mx-'+x)?.classList.toggle('active-bg', t === (x==='hl'?'highlighter':x==='erase'?'scribble':x));
  });
  const ca = document.getElementById('canvas-area');
  ca.className = ca.className.replace(/tool-\w+/g,'') + ' tool-' + t;
  // Update HUD
  document.getElementById('hud-tool').textContent = t.charAt(0).toUpperCase()+t.slice(1);
  // Hide cursors
  ['eraser-cursor','scribble-cursor'].forEach(id => {
    const c = document.getElementById(id); if (c) c.style.display = 'none';
  });
}

function setColor(c, el) {
  drawColor = c;
  document.querySelectorAll('.tool-color-dot').forEach(d => d.classList.remove('active'));
  el?.classList.add('active');
}

function setSize(v) {
  drawSize = v;
  document.getElementById('size-val').textContent = v+'px';
  document.getElementById('hud-size').textContent = v+'px';
}

function setBg(bg) {
  currentBg = bg;
  ['plain','grid','lined','dots'].forEach(b => {
    document.getElementById('bg-'+b+'-btn')?.classList.toggle('active-bg', b===bg);
  });
  redrawBg();
}

function exportPNG() {
  const w = mainCvs.width, h = mainCvs.height;
  const comp = document.createElement('canvas');
  comp.width=w; comp.height=h;
  const ctx = comp.getContext('2d');
  ctx.drawImage(bgCvs, 0, 0); ctx.drawImage(mainCvs, 0, 0);
  const a = document.createElement('a');
  a.download = (notes[activeNote]?.title||'drawing').replace(/\s+/g,'_')+'.png';
  a.href = comp.toDataURL('image/png'); a.click();
  toast('Exported ‚úì', 'green');
}

// ‚îÄ‚îÄ‚îÄ PAGES ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderPagesStrip() {
  if (!activeNote || !drawData[activeNote]) return;
  const d = drawData[activeNote];
  const strip = document.getElementById('pages-strip');
  let h = d.pages.map((pg, i) => `
    <div class="page-thumb${i===d.page?' active':''}" onclick="switchPage(${i})" title="Page ${i+1}">
      <span style="font-family:var(--font-mono);font-size:10px;color:var(--muted)">P${i+1}</span>
      <span class="page-thumb-num">${pg.length} strokes</span>
    </div>`).join('');
  h += `<button class="page-add-btn" onclick="addPage()" title="Add page">Ôºã</button>`;
  strip.innerHTML = h;
}

function switchPage(idx) {
  if (!activeNote) return;
  drawData[activeNote].page = idx;
  renderPagesStrip(); redrawMain(); updateHUD();
}

function addPage() {
  if (!activeNote) return;
  const d = drawData[activeNote];
  d.pages.push([]); d.page = d.pages.length - 1;
  renderPagesStrip(); redrawMain(); updateHUD(); debounceSave();
  toast(`Page ${d.page+1} added`, 'accent');
}

// ‚îÄ‚îÄ‚îÄ PDF IMPORT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function triggerPdfImport() { document.getElementById('pdf-input').click(); }
function handlePdfFile(inp) { if (inp.files?.[0]) importPdf(inp.files[0]); inp.value=''; }

function setupPdfDrop() {
  const ca = document.getElementById('canvas-area');
  ca.addEventListener('dragover', e => { e.preventDefault(); e.dataTransfer.dropEffect='copy'; });
  ca.addEventListener('drop', e => {
    e.preventDefault();
    const f = e.dataTransfer.files[0];
    if (f?.type === 'application/pdf') importPdf(f);
    else toast('Drop a PDF file');
  });
}

async function importPdf(file) {
  if (!activeNote) { toast('Open a note first'); return; }
  if (typeof pdfjsLib === 'undefined') { toast('PDF.js not loaded'); return; }
  const prog = document.getElementById('pdf-progress');
  const fill = document.getElementById('pdf-fill');
  const txt = document.getElementById('pdf-text');
  prog.classList.add('show');

  try {
    const buf = await file.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const total = pdf.numPages;
    txt.textContent = `0/${total} pages`;

    const vp = getVP('main');
    const wrap = document.getElementById('canvas-area');
    let y = (-vp.y / vp.scale) + 20;
    const x = (-vp.x / vp.scale) + 20;

    for (let i = 1; i <= total; i++) {
      fill.style.width = ((i/total)*95)+'%';
      txt.textContent = `${i}/${total} pages`;
      const page = await pdf.getPage(i);
      const pv = page.getViewport({scale: 1.5});
      const c = document.createElement('canvas');
      c.width = pv.width; c.height = pv.height;
      const cx = c.getContext('2d');
      cx.fillStyle='#fff'; cx.fillRect(0,0,c.width,c.height);
      await page.render({canvasContext:cx,viewport:pv}).promise;
      const dataURL = c.toDataURL('image/jpeg', 0.88);
      const img = new Image(); await new Promise(r=>{img.onload=r;img.src=dataURL;});
      const w = pv.width/1.5, h = pv.height/1.5;
      pushStroke({ tool:'pdf_page', x, y, w, h, img, dataURL }, 'main');
      y += h + 24;
    }

    fill.style.width = '100%'; txt.textContent = 'Done!';
    setTimeout(()=>prog.classList.remove('show'), 800);
    setTimeout(()=>fitToContent(), 100);
    notes[activeNote].hasDrawing = true; renderNoteList();
    toast(`Imported ${total} page${total>1?'s':''} ‚úì`, 'green');
  } catch(err) {
    prog.classList.remove('show');
    toast('PDF error: '+err.message);
    console.error(err);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODE SWITCHER
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function setMode(mode) {
  currentMode = mode;
  ['write','draw','mixed'].forEach(m => document.getElementById('mt-'+m)?.classList.toggle('active', m===mode));
  document.getElementById('write-pane').classList.toggle('active', mode==='write');
  document.getElementById('draw-pane').classList.toggle('active', mode==='draw');
  document.getElementById('mixed-pane').classList.toggle('active', mode==='mixed');
  if (mode==='draw'||mode==='mixed') {
    setTimeout(() => { resizeAllCanvases(); redrawMain(); redrawBg(); redrawMix(); redrawMixBg(); }, 60);
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDEBAR + NOTE LIST
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function renderNoteList(filter='') {
  const sorted = Object.values(notes)
    .filter(n => !filter || n.title.toLowerCase().includes(filter.toLowerCase()) || stripHtml(n.content||'').toLowerCase().includes(filter.toLowerCase()))
    .sort((a,b) => new Date(b.modified)-new Date(a.modified));

  document.getElementById('note-list').innerHTML = sorted.map(n => {
    const d = new Date(n.modified).toLocaleDateString('en-US',{month:'short',day:'numeric'});
    const preview = stripHtml(n.content||'').slice(0,60).trim();
    const icon = n.hasDrawing ? '‚úè' : '‚ú¶';
    return `<div class="sb-note${activeNote===n.id?' active':''}" data-id="${n.id}" onclick="openNote('${n.id}')">
      <span class="sb-note-icon">${icon}</span>
      <div class="sb-note-body">
        <div class="sb-note-title">${esc(n.title||'Untitled')}</div>
        <div class="sb-note-meta">${d} ¬∑ ${n._wc||0} words</div>
      </div>
      <button class="sb-note-del" onclick="deleteNote('${n.id}',event)">‚úï</button>
    </div>`;
  }).join('');

  document.getElementById('note-count-badge').textContent = sorted.length + ' notes';
}

function searchNotes(q) { renderNoteList(q); }
function updateStats() {
  const c = Object.keys(notes).length;
  const w = Object.values(notes).reduce((s,n)=>s+(n._wc||0),0);
  document.getElementById('sb-stats-notes').textContent = `${c} note${c!==1?'s':''}`;
  document.getElementById('sb-stats-words').textContent = `${w.toLocaleString()} words`;
  document.getElementById('note-count-badge').textContent = c + ' notes';
}

function renderTagRow(tags) {
  document.getElementById('tag-row').innerHTML = (tags||[]).map(t =>
    `<span class="note-tag">#${esc(t)}</span>`).join('');
}

function promptTag() {
  openModal('Add Tag', 'Tag name‚Ä¶', tag => {
    tag = tag.toLowerCase().trim().replace(/\s+/g,'-');
    if (!tag || !activeNote) return;
    notes[activeNote].tags = [...new Set([...(notes[activeNote].tags||[]), tag])];
    renderTagRow(notes[activeNote].tags); save();
  });
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GRAPH VIEW
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let gNodes=[], gEdges=[], gAnim=null;
function showGraph() {
  document.getElementById('graph-overlay').classList.add('open');
  buildGraph(); animateGraph();
}
function closeGraph() {
  document.getElementById('graph-overlay').classList.remove('open');
  if (gAnim) { cancelAnimationFrame(gAnim); gAnim=null; }
}
function buildGraph() {
  gNodes=[]; gEdges=[];
  const cvs=document.getElementById('graph-canvas');
  cvs.width=cvs.offsetWidth||innerWidth; cvs.height=cvs.offsetHeight||(innerHeight-60);
  const W=cvs.width, H=cvs.height;
  Object.values(notes).forEach((n,i,arr)=>{
    const a=(i/arr.length)*Math.PI*2, r=Math.min(W,H)*.32;
    gNodes.push({id:n.id,label:(n.title||'').slice(0,20),x:W/2+r*Math.cos(a),y:H/2+r*Math.sin(a),vx:0,vy:0,active:n.id===activeNote});
  });
  Object.values(notes).forEach(n=>{
    const wikiLinks=[...((n.content||'').matchAll(/data-target="([^"]+)"/g))].map(m=>m[1]);
    wikiLinks.forEach(title=>{
      const tgt=Object.values(notes).find(x=>x.title.toLowerCase()===title.toLowerCase());
      if(tgt&&tgt.id!==n.id) gEdges.push({from:n.id,to:tgt.id});
    });
  });
}
function animateGraph() {
  const cvs=document.getElementById('graph-canvas');
  if(!cvs||!document.getElementById('graph-overlay').classList.contains('open'))return;
  const ctx=cvs.getContext('2d'), W=cvs.width, H=cvs.height;
  gNodes.forEach(n=>{
    gNodes.forEach(m=>{ if(m.id===n.id)return; const dx=n.x-m.x,dy=n.y-m.y,d=Math.sqrt(dx*dx+dy*dy)||1,f=2000/(d*d); n.vx+=dx/d*f; n.vy+=dy/d*f; });
    n.vx+=(W/2-n.x)*.002; n.vy+=(H/2-n.y)*.002; n.vx*=.85; n.vy*=.85;
    n.x=Math.max(60,Math.min(W-60,n.x+n.vx)); n.y=Math.max(30,Math.min(H-30,n.y+n.vy));
  });
  gEdges.forEach(e=>{
    const a=gNodes.find(n=>n.id===e.from),b=gNodes.find(n=>n.id===e.to); if(!a||!b)return;
    const dx=b.x-a.x,dy=b.y-a.y,d=Math.sqrt(dx*dx+dy*dy)||1,f=(d-120)*.007;
    a.vx+=dx/d*f; a.vy+=dy/d*f; b.vx-=dx/d*f; b.vy-=dy/d*f;
  });
  ctx.clearRect(0,0,W,H);
  gEdges.forEach(e=>{
    const a=gNodes.find(n=>n.id===e.from),b=gNodes.find(n=>n.id===e.to); if(!a||!b)return;
    ctx.beginPath();ctx.moveTo(a.x,a.y);ctx.lineTo(b.x,b.y);ctx.strokeStyle='rgba(212,88,10,.25)';ctx.lineWidth=1.5;ctx.stroke();
  });
  gNodes.forEach(n=>{
    const r=n.active?10:7;
    ctx.beginPath();ctx.arc(n.x,n.y,r,0,Math.PI*2);
    ctx.fillStyle=n.active?'rgba(212,88,10,.9)':'rgba(61,59,53,.45)';ctx.fill();
    ctx.fillStyle='rgba(26,25,22,.75)';ctx.font='10px Geist Mono,monospace';ctx.textAlign='center';
    ctx.fillText(n.label,n.x,n.y-r-6);
  });
  gAnim=requestAnimationFrame(animateGraph);
}
document.getElementById('graph-canvas').addEventListener('click',e=>{
  const cvs=document.getElementById('graph-canvas'),r=cvs.getBoundingClientRect();
  const hit=gNodes.find(n=>Math.hypot(n.x-(e.clientX-r.left),n.y-(e.clientY-r.top))<14);
  if(hit){closeGraph();openNote(hit.id);}
});

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SIDEBAR TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function toggleSidebar() {
  const sb = document.getElementById('sidebar');
  const mobile = window.innerWidth <= 800;
  if (mobile) {
    sb.classList.toggle('open');
    document.getElementById('sb-overlay').classList.toggle('show', sb.classList.contains('open'));
  } else {
    sb.classList.toggle('hidden');
    document.getElementById('wc-bar').classList.toggle('no-sb', sb.classList.contains('hidden'));
  }
}
function closeSidebar() {
  document.getElementById('sidebar').classList.remove('open');
  document.getElementById('sb-overlay').classList.remove('show');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  MODAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function openModal(title, placeholder, cb) {
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-input').placeholder = placeholder;
  document.getElementById('modal-input').value = '';
  modalCallback = cb;
  document.getElementById('modal-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('modal-input').focus(), 50);
}
function closeModal() { document.getElementById('modal-overlay').classList.remove('open'); modalCallback=null; }
function confirmModal() { const v=document.getElementById('modal-input').value.trim(); closeModal(); if(modalCallback)modalCallback(v); }

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  GLOBAL KEYS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function globalKeys(e) {
  const m = e.metaKey||e.ctrlKey;
  if(m&&e.key==='n'){e.preventDefault();newNote();}
  if(m&&e.key==='s'){e.preventDefault();save();toast('Saved ‚úì');}
  if(m&&(e.key==='z'||e.key==='Z')&&!e.shiftKey&&currentMode!=='write'){e.preventDefault();undoDraw();}
  if((m&&e.key==='y')||(m&&e.shiftKey&&e.key==='Z')){if(currentMode!=='write'){e.preventDefault();redoDraw();}}
  if(e.key==='Escape'){closeModal();closeSlash();closeGraph();closeCardModal();}
  if(currentMode==='draw'||currentMode==='mixed'){
    if(!m){
      if(e.key==='p')setTool('pen');
      if(e.key==='m')setTool('marker');
      if(e.key==='h')setTool('highlighter');
      if(e.key==='e')setTool('eraser');
      if(e.key==='x')setTool('scribble');
      if(e.key==='v')setTool('pan');
      if(e.key==='t')setTool('text');
      if(e.key==='='||e.key==='+')zoomStep(0.2);
      if(e.key==='-')zoomStep(-0.2);
      if(e.key==='0')resetViewport();
    }
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function stripHtml(h){const d=document.createElement('div');d.innerHTML=h;return d.innerText||d.textContent||'';}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');}
function autoGrow(el){el.style.height='auto';el.style.height=Math.min(el.scrollHeight,120)+'px';}
function toast(msg,style=''){
  const t=document.getElementById('toast');
  t.textContent=msg; t.className='toast show'+(style?' '+style:'');
  clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2200);
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  THEME TOGGLE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let isDark = false;
function toggleTheme() {
  isDark = !isDark;
  document.documentElement.classList.toggle('dark', isDark);
  const btn = document.getElementById('theme-btn');
  btn.textContent = isDark ? '‚òÄ Light' : '‚òæ Dark';
  localStorage.setItem('cv3_theme', isDark ? 'dark' : 'light');
  // Redraw canvas backgrounds with new palette
  setTimeout(() => { redrawBg(); redrawMixBg(); }, 20);
}

function loadTheme() {
  const saved = localStorage.getItem('cv3_theme');
  if (saved === 'dark') { isDark = true; document.documentElement.classList.add('dark'); document.getElementById('theme-btn').textContent = '‚òÄ Light'; }
}

window.addEventListener('load', init);
window.addEventListener('load', loadTheme);
</script>
</body>
</html>
