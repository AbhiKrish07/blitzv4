<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>The Nexus ‚Äî B.L.I.T.Z.</title>
<link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700&family=Syne:wght@400;600;700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#04050a;--bg2:#07080f;
  --border:rgba(255,255,255,0.07);--border2:rgba(255,255,255,0.13);
  --text:rgba(255,255,255,0.92);--muted:rgba(255,255,255,0.32);--faint:rgba(255,255,255,0.045);
  --accent:#a78bfa;--green:#4ade80;--red:#fb7185;--gold:#fbbf24;--blue:#60a5fa;
  --nexus:#38bdf8;--nexus-dark:#0369a1;
  --font:'Syne',sans-serif;--mono:'Space Mono',monospace;
  --panel:360px;--topbar-h:42px;--statusbar-h:24px;
}
html,body{width:100%;height:100%;overflow:hidden;background:var(--bg);}
body{font-family:var(--font);color:var(--text);-webkit-font-smoothing:antialiased;letter-spacing:.02em;}
body::after{content:'';position:fixed;inset:0;z-index:9999;background:repeating-linear-gradient(0deg,transparent,transparent 2px,rgba(0,0,0,.012) 2px,rgba(0,0,0,.012) 4px);pointer-events:none;}

/* TOPBAR */
.topbar{position:fixed;top:0;left:0;right:0;height:var(--topbar-h);z-index:200;display:flex;align-items:center;background:rgba(4,5,12,.95);backdrop-filter:blur(24px);border-bottom:1px solid var(--border);}
.topbar-left{display:flex;align-items:center;gap:10px;padding:0 14px;border-right:1px solid var(--border);}
.back-btn{display:flex;align-items:center;gap:6px;padding:5px 10px;border-radius:7px;font-family:var(--mono);font-size:10px;color:var(--muted);cursor:pointer;border:1px solid var(--border);background:transparent;transition:all .15s;text-decoration:none;}
.back-btn:hover{color:var(--text);border-color:var(--border2);background:var(--faint);}
.nexus-badge{display:flex;align-items:center;gap:7px;padding:0 14px;font-size:11px;font-weight:700;letter-spacing:.12em;color:var(--nexus);}
.nexus-dot{width:7px;height:7px;border-radius:50%;background:var(--nexus);box-shadow:0 0 10px rgba(56,189,248,.7);animation:nexus-pulse 2s ease-in-out infinite;}
@keyframes nexus-pulse{0%,100%{opacity:1;box-shadow:0 0 10px rgba(56,189,248,.7)}50%{opacity:.6;box-shadow:0 0 22px rgba(56,189,248,.3)}}
.url-bar{flex:1;display:flex;align-items:center;gap:8px;padding:0 16px;}
.url-input{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;padding:6px 12px;font-family:var(--mono);font-size:11px;color:var(--text);outline:none;caret-color:var(--nexus);transition:border-color .15s;max-width:500px;}
.url-input:focus{border-color:rgba(56,189,248,.3);}
.url-go{padding:5px 14px;border-radius:7px;font-family:var(--mono);font-size:9px;font-weight:700;background:rgba(56,189,248,.1);border:1px solid rgba(56,189,248,.25);color:var(--nexus);cursor:pointer;transition:all .15s;}
.url-go:hover{background:rgba(56,189,248,.2);border-color:rgba(56,189,248,.45);}
.topbar-right{display:flex;align-items:center;gap:8px;padding:0 14px;border-left:1px solid var(--border);}
.tb-btn{padding:5px 10px;border-radius:6px;font-family:var(--mono);font-size:9px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;transition:all .15s;}
.tb-btn:hover{border-color:var(--border2);color:var(--text);background:var(--faint);}
.api-pill{display:flex;align-items:center;gap:5px;font-family:var(--mono);font-size:9px;color:var(--muted);}
.api-dot{width:5px;height:5px;border-radius:50%;background:var(--muted);}
.api-dot.on{background:var(--green);box-shadow:0 0 6px rgba(74,222,128,.6);}
.api-dot.off{background:var(--red);}

/* LAYOUT */
.layout{position:fixed;top:var(--topbar-h);bottom:var(--statusbar-h);left:0;right:0;display:flex;}

/* DESKTOP AREA */
.desktop{flex:1;position:relative;overflow:hidden;background:radial-gradient(ellipse 80% 70% at 50% 50%, rgba(56,189,248,.03) 0%, transparent 70%);}
.desktop-bg-grid{position:absolute;inset:0;background-image:linear-gradient(rgba(56,189,248,.015) 1px,transparent 1px),linear-gradient(90deg,rgba(56,189,248,.015) 1px,transparent 1px);background-size:48px 48px;}
.empty-state{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:12px;pointer-events:none;}
.empty-icon{font-size:48px;opacity:.15;}
.empty-title{font-size:20px;font-weight:800;color:rgba(255,255,255,.1);letter-spacing:-.02em;}
.empty-sub{font-family:var(--mono);font-size:11px;color:rgba(255,255,255,.08);}

/* ‚îÄ‚îÄ HOVERING WINDOWS ‚îÄ‚îÄ */
.hud-window{
  position:absolute;
  min-width:320px;min-height:240px;
  background:rgba(6,8,20,.94);backdrop-filter:blur(28px) saturate(160%);
  border:1px solid rgba(56,189,248,.18);
  border-radius:14px;
  box-shadow:0 24px 80px rgba(0,0,0,.7),0 0 0 1px rgba(56,189,248,.05),0 0 60px rgba(56,189,248,.04);
  display:flex;flex-direction:column;
  overflow:hidden;
  z-index:100;
  animation:win-spawn .2s cubic-bezier(.34,1.56,.64,1);
}
@keyframes win-spawn{from{opacity:0;transform:scale(.92) translateY(8px)}to{opacity:1;transform:scale(1) translateY(0)}}
.hud-window.focused{border-color:rgba(56,189,248,.32);z-index:150;}
.hud-window.minimized .hud-body{display:none;}
.hud-window.minimized{min-height:0!important;height:auto!important;resize:none;}

.hud-titlebar{
  display:flex;align-items:center;gap:8px;padding:9px 12px;
  border-bottom:1px solid rgba(255,255,255,.05);
  cursor:move;flex-shrink:0;user-select:none;
  background:rgba(56,189,248,.04);
}
.hud-dots{display:flex;gap:5px;}
.hud-dot{width:10px;height:10px;border-radius:50%;cursor:pointer;transition:opacity .15s;}
.hud-dot:hover{opacity:.7;}
.hud-dot.close{background:#ff5f57;}
.hud-dot.min{background:#ffbd2e;}
.hud-dot.max{background:#28ca41;}
.hud-url{flex:1;font-family:var(--mono);font-size:9.5px;color:var(--muted);text-overflow:ellipsis;overflow:hidden;white-space:nowrap;margin:0 6px;}
.hud-type-badge{font-family:var(--mono);font-size:8px;padding:1px 6px;border-radius:4px;background:rgba(56,189,248,.1);color:rgba(56,189,248,.7);border:1px solid rgba(56,189,248,.2);flex-shrink:0;}
.hud-loading-bar{height:2px;background:rgba(56,189,248,.15);overflow:hidden;flex-shrink:0;}
.hud-loading-fill{height:100%;background:rgba(56,189,248,.6);width:0%;transition:width .4s;animation:none;}
.hud-loading-fill.active{animation:load-sweep 1.5s ease-in-out infinite;}
@keyframes load-sweep{0%{width:0%;margin-left:0}50%{width:60%;margin-left:20%}100%{width:0%;margin-left:100%}}

.hud-body{flex:1;overflow:hidden;position:relative;}
.hud-iframe{width:100%;height:100%;border:none;background:#fff;}
.hud-blocked{
  padding:20px;height:100%;overflow-y:auto;
  font-family:var(--mono);font-size:11px;line-height:1.7;color:var(--muted);
}
.hud-blocked::-webkit-scrollbar{width:3px;}
.hud-blocked::-webkit-scrollbar-thumb{background:var(--border2);}
.hud-blocked .block-badge{display:inline-flex;align-items:center;gap:5px;margin-bottom:12px;padding:4px 10px;border-radius:6px;background:rgba(251,191,36,.08);border:1px solid rgba(251,191,36,.2);color:var(--gold);font-size:9px;}
.hud-blocked .scraped-title{font-size:14px;font-weight:700;color:var(--text);margin-bottom:10px;font-family:var(--font);}
.hud-blocked .scraped-body{color:rgba(255,255,255,.65);font-family:var(--font);font-size:12px;line-height:1.8;}
.hud-blocked .scraped-body h2,.hud-blocked .scraped-body h3{color:var(--nexus);margin:12px 0 6px;font-size:12px;letter-spacing:.05em;}
.hud-blocked .scraped-body strong{color:var(--text);}
.hud-blocked .scraped-body code{background:rgba(255,255,255,.07);padding:1px 4px;border-radius:3px;font-size:10px;}
.hud-resize-handle{position:absolute;bottom:0;right:0;width:14px;height:14px;cursor:nwse-resize;z-index:10;}
.hud-resize-handle::after{content:'';position:absolute;bottom:3px;right:3px;width:7px;height:7px;border-right:2px solid rgba(56,189,248,.25);border-bottom:2px solid rgba(56,189,248,.25);}

/* Window toolbar */
.hud-toolbar{display:flex;align-items:center;gap:4px;padding:5px 10px;border-bottom:1px solid var(--border);background:rgba(255,255,255,.01);flex-shrink:0;}
.hud-tb-btn{padding:3px 7px;border-radius:4px;font-family:var(--mono);font-size:8.5px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;transition:all .12s;}
.hud-tb-btn:hover{border-color:rgba(56,189,248,.3);color:var(--nexus);}
.hud-url-bar{flex:1;background:rgba(255,255,255,.03);border:1px solid var(--border);border-radius:5px;padding:3px 8px;font-family:var(--mono);font-size:9.5px;color:var(--text);outline:none;}
.hud-url-bar:focus{border-color:rgba(56,189,248,.3);}

/* BLITZ PANEL */
.blitz-panel{width:var(--panel);flex-shrink:0;display:flex;flex-direction:column;border-left:1px solid var(--border);background:rgba(4,5,14,.92);backdrop-filter:blur(24px);overflow:hidden;transition:width .25s cubic-bezier(.4,0,.2,1);}
.blitz-panel.collapsed{width:0;}
.blitz-header{padding:12px 14px 10px;border-bottom:1px solid var(--border);flex-shrink:0;display:flex;align-items:center;gap:8px;}
.blitz-logo{font-size:13px;font-weight:800;letter-spacing:-.02em;flex:1;}
.blitz-logo span{color:var(--nexus);}
.blitz-mode-badge{padding:3px 8px;border-radius:6px;font-family:var(--mono);font-size:9px;font-weight:700;background:rgba(56,189,248,.1);color:var(--nexus);border:1px solid rgba(56,189,248,.22);}

/* Window manager strip */
.win-strip{padding:8px;border-bottom:1px solid var(--border);flex-shrink:0;}
.win-strip-title{font-family:var(--mono);font-size:8px;font-weight:700;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;padding:0 4px;display:flex;align-items:center;justify-content:space-between;}
.win-strip-clear{font-family:var(--mono);font-size:8px;color:var(--muted);cursor:pointer;padding:2px 5px;border-radius:3px;border:1px solid var(--border);background:transparent;transition:all .12s;}
.win-strip-clear:hover{color:var(--red);border-color:rgba(251,113,133,.3);}
.win-list{display:flex;flex-direction:column;gap:4px;max-height:120px;overflow-y:auto;}
.win-list::-webkit-scrollbar{width:2px;}
.win-item{display:flex;align-items:center;gap:6px;padding:5px 8px;border-radius:6px;border:1px solid var(--border);background:var(--faint);cursor:pointer;transition:all .12s;}
.win-item:hover{border-color:rgba(56,189,248,.25);background:rgba(56,189,248,.06);}
.win-item.focused{border-color:rgba(56,189,248,.35);background:rgba(56,189,248,.08);}
.win-item-icon{font-size:12px;}
.win-item-title{flex:1;font-family:var(--mono);font-size:9px;color:var(--muted);text-overflow:ellipsis;overflow:hidden;white-space:nowrap;}
.win-item-close{font-size:10px;color:var(--muted);padding:1px 4px;border-radius:3px;transition:all .12s;}
.win-item-close:hover{background:rgba(251,113,133,.15);color:var(--red);}

/* Quick research */
.quick-research{padding:8px;border-bottom:1px solid var(--border);flex-shrink:0;}
.qr-title{font-family:var(--mono);font-size:8px;font-weight:700;letter-spacing:.16em;text-transform:uppercase;color:var(--muted);margin-bottom:6px;padding:0 4px;}
.qr-chips{display:flex;flex-wrap:wrap;gap:4px;}
.qr-chip{padding:4px 9px;border-radius:5px;font-family:var(--mono);font-size:8.5px;border:1px solid var(--border);background:transparent;color:var(--muted);cursor:pointer;transition:all .12s;}
.qr-chip:hover{border-color:rgba(56,189,248,.3);color:var(--nexus);background:rgba(56,189,248,.05);}

/* Chat */
.blitz-feed{flex:1;overflow-y:auto;padding:10px;display:flex;flex-direction:column;gap:6px;}
.blitz-feed::-webkit-scrollbar{width:2px;}
.blitz-feed::-webkit-scrollbar-thumb{background:var(--border2);}
.b-msg{display:flex;flex-direction:column;gap:2px;max-width:96%;}
.b-msg.u{align-self:flex-end;align-items:flex-end;}
.b-msg.b{align-self:flex-start;align-items:flex-start;}
.b-who{font-family:var(--mono);font-size:7.5px;color:var(--muted);letter-spacing:.08em;}
.b-bubble{padding:8px 11px;border-radius:10px;font-size:11.5px;line-height:1.55;cursor:text;user-select:text;}
.b-msg.u .b-bubble{background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.18);}
.b-msg.b .b-bubble{background:rgba(56,189,248,.04);border:1px solid rgba(56,189,248,.12);}
.b-bubble code{font-family:var(--mono);font-size:10px;background:rgba(255,255,255,.07);padding:1px 4px;border-radius:3px;}
.b-bubble a{color:var(--nexus);text-decoration:none;font-family:var(--mono);font-size:10px;}
.b-bubble a:hover{text-decoration:underline;}
.b-ts{font-family:var(--mono);font-size:7px;color:var(--muted);}
.b-typing{align-self:flex-start;padding:9px 12px;background:rgba(56,189,248,.06);border:1px solid rgba(56,189,248,.12);border-radius:10px;display:flex;gap:4px;align-items:center;}
.tdot{width:4px;height:4px;border-radius:50%;background:rgba(56,189,248,.5);animation:tdot-bounce 1.2s ease-in-out infinite;}
.tdot:nth-child(2){animation-delay:.2s}.tdot:nth-child(3){animation-delay:.4s}
@keyframes tdot-bounce{0%,80%,100%{transform:translateY(0)}40%{transform:translateY(-5px)}}

/* Spawn button on message */
.spawn-btn{
  display:inline-flex;align-items:center;gap:5px;margin:4px 2px 0 0;
  padding:4px 10px;border-radius:5px;font-family:var(--mono);font-size:9px;font-weight:700;
  background:rgba(56,189,248,.08);border:1px solid rgba(56,189,248,.22);color:var(--nexus);
  cursor:pointer;transition:all .15s;
}
.spawn-btn:hover{background:rgba(56,189,248,.18);}

/* Input */
.blitz-input-area{padding:10px 12px;border-top:1px solid var(--border);background:rgba(255,255,255,.01);flex-shrink:0;}
.b-input-row{display:flex;gap:6px;align-items:center;}
.b-inp{flex:1;background:rgba(255,255,255,.04);border:1px solid var(--border);border-radius:8px;padding:7px 10px;font-family:var(--mono);font-size:11px;color:var(--text);outline:none;caret-color:var(--text);transition:border-color .15s;}
.b-inp:focus{border-color:rgba(56,189,248,.3);}
.b-send{width:32px;height:32px;border-radius:7px;flex-shrink:0;cursor:pointer;border:1px solid rgba(56,189,248,.25);background:rgba(56,189,248,.07);color:rgba(56,189,248,.7);font-size:12px;display:flex;align-items:center;justify-content:center;transition:all .15s;}
.b-send:hover{background:rgba(56,189,248,.16);color:var(--nexus);}

/* STATUS BAR */
.statusbar{position:fixed;bottom:0;left:0;right:0;height:var(--statusbar-h);z-index:200;display:flex;align-items:center;background:rgba(56,189,248,.06);border-top:1px solid rgba(56,189,248,.12);font-family:var(--mono);font-size:9.5px;}
.sb-section{display:flex;align-items:center;gap:8px;padding:0 12px;border-right:1px solid rgba(56,189,248,.1);height:100%;color:rgba(56,189,248,.55);}
.sb-section:last-child{border-right:none;margin-left:auto;}

/* TOAST */
.toast{position:fixed;bottom:36px;left:50%;transform:translateX(-50%) translateY(8px);z-index:9000;background:rgba(8,9,22,.97);border:1px solid var(--border2);border-radius:9px;padding:7px 14px;font-family:var(--mono);font-size:11px;color:var(--text);opacity:0;pointer-events:none;transition:all .3s cubic-bezier(.34,1.56,.64,1);}
.toast.show{opacity:1;transform:translateX(-50%) translateY(0);}
.toast.nexus{border-color:rgba(56,189,248,.35);color:var(--nexus);}
</style>
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
  <div class="topbar-left">
    <a href="index.html" class="back-btn">‚Üê Hub</a>
    <div class="nexus-badge"><div class="nexus-dot"></div>THE NEXUS</div>
  </div>

  <div class="url-bar">
    <input type="text" class="url-input" id="url-input" placeholder="Enter URL or search query..." />
    <button class="url-go" onclick="openFromBar()">‚ñ∂ Open</button>
  </div>

  <div class="topbar-right">
    <button class="tb-btn" onclick="tileWindows()">‚¨° Tile</button>
    <button class="tb-btn" onclick="closeAllWindows()">‚úï Close All</button>
    <button class="tb-btn" onclick="toggleBlitz()">‚ö° Blitz</button>
    <div class="api-pill">
      <div class="api-dot" id="api-dot"></div>
      <span id="api-lbl">‚Äî</span>
    </div>
  </div>
</div>

<!-- LAYOUT -->
<div class="layout">
  <!-- DESKTOP -->
  <div class="desktop" id="desktop">
    <div class="desktop-bg-grid"></div>
    <div class="empty-state" id="empty-state">
      <div class="empty-icon">‚¨°</div>
      <div class="empty-title">The Nexus</div>
      <div class="empty-sub">Ask B.L.I.T.Z. to open a URL ‚Äî or type one in the bar above</div>
    </div>
    <!-- Windows spawn here -->
  </div>

  <!-- BLITZ PANEL -->
  <div class="blitz-panel" id="blitz-panel">
    <div class="blitz-header">
      <div class="blitz-logo">B.L.I.T.<span>Z</span>.</div>
      <div class="blitz-mode-badge">RESEARCH</div>
    </div>

    <!-- Window manager -->
    <div class="win-strip">
      <div class="win-strip-title">
        Open Windows
        <button class="win-strip-clear" onclick="closeAllWindows()">Close all</button>
      </div>
      <div class="win-list" id="win-list"><div style="font-family:var(--mono);font-size:9px;color:var(--muted);padding:4px;">No windows open</div></div>
    </div>

    <!-- Quick research chips -->
    <div class="quick-research">
      <div class="qr-title">Quick Open</div>
      <div class="qr-chips">
        <button class="qr-chip" onclick="spawnWindow('https://en.wikipedia.org', 'Wikipedia', 'üìñ')">üìñ Wikipedia</button>
        <button class="qr-chip" onclick="spawnWindow('https://www.wolframalpha.com', 'Wolfram Alpha', 'üî¢')">üî¢ Wolfram</button>
        <button class="qr-chip" onclick="spawnWindow('https://arxiv.org', 'arXiv', 'üìÑ')">üìÑ arXiv</button>
        <button class="qr-chip" onclick="spawnWindow('https://www.desmos.com/calculator', 'Desmos', 'üìà')">üìà Desmos</button>
        <button class="qr-chip" onclick="spawnWindow('https://github.com', 'GitHub', 'üêô')">üêô GitHub</button>
        <button class="qr-chip" onclick="spawnWindow('https://stackoverflow.com', 'StackOverflow', 'üí¨')">üí¨ Stack</button>
      </div>
    </div>

    <!-- Chat feed -->
    <div class="blitz-feed" id="blitz-feed"></div>

    <!-- Input -->
    <div class="blitz-input-area">
      <div class="b-input-row">
        <input type="text" class="b-inp" id="b-inp" placeholder='Ask: "Research quantum entanglement" or "Open Wikipedia"...' />
        <button class="b-send" onclick="sendNexus()">‚Üë</button>
      </div>
    </div>
  </div>
</div>

<!-- STATUS BAR -->
<div class="statusbar">
  <div class="sb-section"><span>‚¨°</span><span id="sb-windows">0 windows</span></div>
  <div class="sb-section"><span id="sb-mode">research mode</span></div>
  <div class="sb-section" style="margin-left:auto"><span id="sb-api">‚Äî</span></div>
</div>

<!-- TOAST -->
<div class="toast" id="toast"></div>

<script>
const API = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
  ? 'http://localhost:8000'
  : window.location.origin;
let toastTimer;
let apiOnline = false;
let windows = {};
let winZIndex = 100;
let winCount = 0;
let focusedWin = null;

// ‚îÄ‚îÄ SPAWN WINDOW ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function spawnWindow(url, title, icon = 'üåê', initialWidth = 680, initialHeight = 480) {
  const desktop = document.getElementById('desktop');
  const id = 'win_' + (++winCount);
  const emptyState = document.getElementById('empty-state');
  emptyState.style.display = 'none';

  // Stagger position
  const offsetX = 60 + (winCount % 4) * 32;
  const offsetY = 60 + (winCount % 3) * 24;
  const desktopRect = desktop.getBoundingClientRect();
  const left = Math.min(offsetX, desktopRect.width - initialWidth - 20);
  const top = Math.min(offsetY, desktopRect.height - initialHeight - 20);

  const win = document.createElement('div');
  win.className = 'hud-window focused';
  win.id = id;
  win.style.cssText = `left:${left}px;top:${top}px;width:${initialWidth}px;height:${initialHeight}px;`;

  const safeTitle = esc(title.slice(0, 40));
  const safeUrl = esc(url);

  win.innerHTML = `
    <div class="hud-titlebar" id="${id}-titlebar">
      <div class="hud-dots">
        <div class="hud-dot close" onclick="closeWindow('${id}')"></div>
        <div class="hud-dot min" onclick="minimizeWindow('${id}')"></div>
        <div class="hud-dot max" onclick="maximizeWindow('${id}')"></div>
      </div>
      <span class="hud-url" id="${id}-urldisp">${icon} ${safeTitle}</span>
      <span class="hud-type-badge" id="${id}-badge">LOADING</span>
    </div>
    <div class="hud-loading-bar"><div class="hud-loading-fill active" id="${id}-loader"></div></div>
    <div class="hud-toolbar">
      <button class="hud-tb-btn" onclick="navBack('${id}')">‚Üê</button>
      <button class="hud-tb-btn" onclick="navRefresh('${id}')">‚Üª</button>
      <input type="text" class="hud-url-bar" id="${id}-urlbar" value="${safeUrl}" onkeydown="if(event.key==='Enter')navTo('${id}',this.value)" />
      <button class="hud-tb-btn" onclick="askAboutWindow('${id}')">‚ö° Ask Blitz</button>
      <button class="hud-tb-btn" onclick="popOutWindow('${id}')">‚¨°</button>
    </div>
    <div class="hud-body" id="${id}-body">
      <div style="display:flex;align-items:center;justify-content:center;height:100%;font-family:var(--mono);font-size:11px;color:var(--muted);">
        ‚¨° Loading...
      </div>
    </div>
    <div class="hud-resize-handle" id="${id}-resize"></div>
  `;

  desktop.appendChild(win);
  windows[id] = { url, title, icon, minimized: false, maximized: false, preMaxPos: null };

  // Focus management
  focusWindow(id);
  makeDraggable(win, document.getElementById(`${id}-titlebar`));
  makeResizable(win, document.getElementById(`${id}-resize`));

  // Try to load iframe
  loadWindowContent(id, url, title, icon);
  updateWindowStrip();
  updateStatusBar();

  return id;
}

async function loadWindowContent(id, url, title, icon) {
  const body = document.getElementById(`${id}-body`);
  const badge = document.getElementById(`${id}-badge`);
  const loader = document.getElementById(`${id}-loader`);
  if (!body) return;

  // Attempt iframe first
  badge.textContent = 'IFRAME';
  badge.style.color = 'var(--nexus)';

  const iframe = document.createElement('iframe');
  iframe.className = 'hud-iframe';
  iframe.sandbox = 'allow-scripts allow-same-origin allow-forms allow-popups';
  iframe.src = url;

  let blocked = false;

  // Timeout ‚Äî if iframe doesn't load in 5s, assume blocked
  const loadTimeout = setTimeout(async () => {
    if (!blocked) {
      blocked = true;
      iframe.src = 'about:blank';
      body.innerHTML = '';
      badge.textContent = 'SCRAPED';
      badge.style.color = 'var(--gold)';
      await loadScrapedContent(id, url, title, icon);
    }
    stopLoader(id);
  }, 6000);

  iframe.onload = () => {
    if (!blocked) {
      clearTimeout(loadTimeout);
      stopLoader(id);
      badge.textContent = 'LIVE';
      badge.style.color = 'var(--green)';
    }
  };

  iframe.onerror = async () => {
    if (!blocked) {
      blocked = true;
      clearTimeout(loadTimeout);
      body.innerHTML = '';
      badge.textContent = 'SCRAPED';
      badge.style.color = 'var(--gold)';
      await loadScrapedContent(id, url, title, icon);
      stopLoader(id);
    }
  };

  body.innerHTML = '';
  body.appendChild(iframe);
}

function stopLoader(id) {
  const loader = document.getElementById(`${id}-loader`);
  if (loader) { loader.classList.remove('active'); loader.style.width = '100%'; setTimeout(() => loader.style.width = '0', 400); }
}

async function loadScrapedContent(id, url, title, icon) {
  const body = document.getElementById(`${id}-body`);
  if (!body) return;

  body.innerHTML = `<div class="hud-blocked">
    <div class="block-badge">‚ö†Ô∏è IFRAME BLOCKED ‚Äî SCRAPED VIA B.L.I.T.Z.</div>
    <div class="scraped-title" id="${id}-stitle">Fetching content for: ${esc(url)}</div>
    <div class="scraped-body" id="${id}-sbody"><div style="color:var(--muted);font-family:var(--mono);font-size:10px;animation:tdot-bounce 1s ease-in-out infinite">Retrieving page content...</div></div>
  </div>`;

  // Try to get scraped content from backend
  let content = '';
  try {
    const r = await fetch(`${API}/api/scrape`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ url }),
      signal: AbortSignal.timeout(12000)
    });
    const d = await r.json();
    content = d.content || d.text || '';
    const stitle = document.getElementById(`${id}-stitle`);
    if (stitle) stitle.textContent = d.title || title;
  } catch {
    // Backend offline: use Blitz to summarize what page might contain
    content = await simulateScrapedContent(url, title);
  }

  const sbody = document.getElementById(`${id}-sbody`);
  if (sbody) sbody.innerHTML = renderMD(content);
}

async function simulateScrapedContent(url, title) {
  // When backend is offline, use Blitz to generate a placeholder description
  const domain = new URL(url).hostname.replace('www.', '');
  return `**${title}** ‚Äî *${domain}*\n\n*Connect the backend to scrape live content from this URL.*\n\nTo enable real scraping:\n1. Start the FastAPI backend\n2. Ensure Tavily API key is configured\n3. The backend will fetch and parse the page content\n\n**About this site:** \`${url}\`\n\nB.L.I.T.Z. can answer questions about this topic even without the live page. Try asking in the chat panel.`;
}

// ‚îÄ‚îÄ WINDOW CONTROLS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function closeWindow(id) {
  const win = document.getElementById(id);
  if (!win) return;
  win.style.animation = 'none';
  win.style.transition = 'all .15s';
  win.style.opacity = '0'; win.style.transform = 'scale(.95)';
  setTimeout(() => { win.remove(); delete windows[id]; updateWindowStrip(); updateStatusBar(); checkEmpty(); }, 150);
}

function minimizeWindow(id) {
  const win = document.getElementById(id);
  if (!win) return;
  win.classList.toggle('minimized');
  windows[id].minimized = win.classList.contains('minimized');
  updateWindowStrip();
}

function maximizeWindow(id) {
  const win = document.getElementById(id);
  const desktop = document.getElementById('desktop');
  if (!win) return;
  const w = windows[id];
  if (!w.maximized) {
    w.preMaxPos = { left: win.style.left, top: win.style.top, width: win.style.width, height: win.style.height };
    win.style.left = '4px'; win.style.top = '4px';
    win.style.width = (desktop.offsetWidth - 8) + 'px';
    win.style.height = (desktop.offsetHeight - 8) + 'px';
    w.maximized = true;
  } else {
    const p = w.preMaxPos;
    win.style.left = p.left; win.style.top = p.top;
    win.style.width = p.width; win.style.height = p.height;
    w.maximized = false;
  }
}

function focusWindow(id) {
  Object.keys(windows).forEach(wid => document.getElementById(wid)?.classList.remove('focused'));
  document.getElementById(id)?.classList.add('focused');
  document.getElementById(id).style.zIndex = ++winZIndex;
  focusedWin = id;
  document.querySelectorAll('.win-item').forEach(el => el.classList.toggle('focused', el.dataset.id === id));
}

function closeAllWindows() {
  Object.keys(windows).forEach(id => closeWindow(id));
}

function tileWindows() {
  const ids = Object.keys(windows).filter(id => !windows[id].minimized);
  if (!ids.length) return;
  const desktop = document.getElementById('desktop');
  const w = desktop.offsetWidth, h = desktop.offsetHeight;
  const cols = Math.ceil(Math.sqrt(ids.length));
  const rows = Math.ceil(ids.length / cols);
  const tw = Math.floor(w / cols) - 8;
  const th = Math.floor(h / rows) - 8;
  ids.forEach((id, i) => {
    const win = document.getElementById(id);
    const col = i % cols, row = Math.floor(i / cols);
    win.style.left = (col * (tw + 8) + 4) + 'px';
    win.style.top = (row * (th + 8) + 4) + 'px';
    win.style.width = tw + 'px';
    win.style.height = th + 'px';
  });
  toast('Windows tiled', true);
}

function checkEmpty() {
  const hasWindows = Object.keys(windows).length > 0;
  document.getElementById('empty-state').style.display = hasWindows ? 'none' : 'flex';
}

function navTo(id, url) {
  if (!url.startsWith('http')) url = 'https://' + url;
  windows[id].url = url;
  windows[id].title = url;
  document.getElementById(`${id}-urlbar`).value = url;
  loadWindowContent(id, url, url, 'üåê');
}

function navBack(id) {
  const iframe = document.querySelector(`#${id}-body iframe`);
  if (iframe) try { iframe.contentWindow.history.back(); } catch(e){}
}
function navRefresh(id) {
  const w = windows[id];
  if (w) loadWindowContent(id, w.url, w.title, w.icon);
}

function popOutWindow(id) {
  const w = windows[id];
  if (w) window.open(w.url, '_blank');
}

function askAboutWindow(id) {
  const w = windows[id];
  if (w) {
    document.getElementById('b-inp').value = `What can you tell me about the content at ${w.url}?`;
    document.getElementById('b-inp').focus();
  }
}

// ‚îÄ‚îÄ DRAGGABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeDraggable(el, handle) {
  let drag = false, sx, sy, ox, oy;
  handle.addEventListener('mousedown', e => {
    if (e.target.classList.contains('hud-dot') || e.target.classList.contains('hud-tb-btn') || e.target.tagName === 'INPUT') return;
    drag = true;
    sx = e.clientX; sy = e.clientY;
    ox = el.offsetLeft; oy = el.offsetTop;
    focusWindow(el.id); e.preventDefault();
  });
  document.addEventListener('mousemove', e => {
    if (!drag) return;
    el.style.left = Math.max(0, ox + e.clientX - sx) + 'px';
    el.style.top = Math.max(0, oy + e.clientY - sy) + 'px';
  });
  document.addEventListener('mouseup', () => { drag = false; });
  el.addEventListener('mousedown', () => focusWindow(el.id));
}

// ‚îÄ‚îÄ RESIZABLE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function makeResizable(el, handle) {
  let resize = false, sx, sy, sw, sh;
  handle.addEventListener('mousedown', e => {
    resize = true; sx = e.clientX; sy = e.clientY;
    sw = el.offsetWidth; sh = el.offsetHeight; e.preventDefault(); e.stopPropagation();
  });
  document.addEventListener('mousemove', e => {
    if (!resize) return;
    el.style.width = Math.max(300, sw + e.clientX - sx) + 'px';
    el.style.height = Math.max(200, sh + e.clientY - sy) + 'px';
  });
  document.addEventListener('mouseup', () => { resize = false; });
}

// ‚îÄ‚îÄ WINDOW STRIP ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function updateWindowStrip() {
  const list = document.getElementById('win-list');
  const ids = Object.keys(windows);
  if (!ids.length) { list.innerHTML = '<div style="font-family:var(--mono);font-size:9px;color:var(--muted);padding:4px;">No windows open</div>'; return; }
  list.innerHTML = ids.map(id => {
    const w = windows[id];
    return `<div class="win-item ${id===focusedWin?'focused':''}" data-id="${id}" onclick="focusWindow('${id}')">
      <span class="win-item-icon">${w.icon}</span>
      <span class="win-item-title">${esc(w.title.slice(0,28))}</span>
      <span class="win-item-close" onclick="event.stopPropagation();closeWindow('${id}')">‚úï</span>
    </div>`;
  }).join('');
}

function updateStatusBar() {
  const c = Object.keys(windows).length;
  document.getElementById('sb-windows').textContent = `${c} window${c!==1?'s':''}`;
}

// ‚îÄ‚îÄ TOP BAR URL OPEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function openFromBar() {
  let url = document.getElementById('url-input').value.trim();
  if (!url) return;
  if (!url.startsWith('http')) url = 'https://' + url;
  const title = new URL(url).hostname.replace('www.', '');
  spawnWindow(url, title, 'üåê');
  document.getElementById('url-input').value = '';
}

document.getElementById('url-input').addEventListener('keydown', e => {
  if (e.key === 'Enter') openFromBar();
});

// ‚îÄ‚îÄ API ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function checkAPI() {
  try {
    const r = await fetch(`${API}/`, { signal: AbortSignal.timeout(3000) });
    if (r.ok) {
      apiOnline = true;
      document.getElementById('api-dot').className = 'api-dot on';
      document.getElementById('api-lbl').textContent = 'API online';
      document.getElementById('sb-api').textContent = 'online';
    }
  } catch {
    document.getElementById('api-dot').className = 'api-dot off';
    document.getElementById('api-lbl').textContent = 'API offline';
    document.getElementById('sb-api').textContent = 'offline';
  }
}
checkAPI(); setInterval(checkAPI, 10000);

// ‚îÄ‚îÄ BLITZ CHAT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const NEXUS_SYSTEM = `You are B.L.I.T.Z. in NEXUS/RESEARCH mode. You can spawn research windows and search the web.

When the user asks you to open/research a URL or topic, respond naturally AND include one or more URL directives in this exact format:
[SPAWN: https://url.com | Title | üåê]

Example:
User: "Open Wikipedia article on quantum entanglement"
Response: Sure, opening Wikipedia for quantum entanglement.
[SPAWN: https://en.wikipedia.org/wiki/Quantum_entanglement | Quantum Entanglement ‚Äî Wikipedia | üìñ]

For research questions, provide a thorough answer AND optionally spawn relevant sources.
Always be helpful, sharp, and direct.`;

async function sendNexus() {
  const inp = document.getElementById('b-inp');
  const text = inp.value.trim();
  if (!text) return;
  inp.value = '';
  addMsg('u', text);
  showTyping();

  let response = '';
  try {
    const r = await fetch(`${API}/api/command`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ text, active_modules: ['research'], system_override: NEXUS_SYSTEM }),
      signal: AbortSignal.timeout(20000)
    });
    const d = await r.json();
    response = d.response;
  } catch {
    response = simulateNexus(text);
  }
  hideTyping();

  // Parse spawn directives
  const spawnDirectives = [...response.matchAll(/\[SPAWN:\s*(https?:\/\/[^\s|]+)\s*\|\s*([^|\]]+)\s*\|\s*([^\]]+)\]/g)];
  const cleanResponse = response.replace(/\[SPAWN:[^\]]+\]/g, '').trim();

  const div = addMsg('b', cleanResponse);

  // Add spawn buttons for each directive
  if (div && spawnDirectives.length > 0) {
    const bubble = div.querySelector('.b-bubble');
    if (bubble) {
      const btnRow = document.createElement('div');
      btnRow.style.marginTop = '6px';
      spawnDirectives.forEach(([_, url, title, icon]) => {
        const btn = document.createElement('button');
        btn.className = 'spawn-btn';
        btn.innerHTML = `${icon.trim()} Open: ${esc(title.trim().slice(0, 25))}`;
        btn.onclick = () => spawnWindow(url.trim(), title.trim(), icon.trim());
        btnRow.appendChild(btn);
        // Auto-spawn
        setTimeout(() => spawnWindow(url.trim(), title.trim(), icon.trim()), 300);
      });
      bubble.appendChild(btnRow);
    }
  }
}

function simulateNexus(text) {
  const t = text.toLowerCase();
  if (t.includes('wikipedia') || t.includes('wiki')) {
    const topic = text.replace(/wiki(pedia)?/gi, '').replace(/open|show|search/gi, '').trim().replace(/\s+/g, '_');
    const url = topic ? `https://en.wikipedia.org/wiki/${encodeURIComponent(topic)}` : 'https://en.wikipedia.org';
    return `Opening Wikipedia for **${topic.replace(/_/g,' ') || 'home'}**.\n[SPAWN: ${url} | ${topic.replace(/_/g,' ') || 'Wikipedia'} | üìñ]`;
  }
  if (t.includes('wolfram') || t.includes('calculator') || t.includes('math')) {
    return `Opening Wolfram Alpha ‚Äî the computational engine.\n[SPAWN: https://www.wolframalpha.com | Wolfram Alpha | üî¢]`;
  }
  if (t.includes('arxiv') || t.includes('paper') || t.includes('research')) {
    return `Opening arXiv for research papers. Connect the backend for AI-powered research summaries.\n[SPAWN: https://arxiv.org | arXiv Research Papers | üìÑ]`;
  }
  if (t.includes('github')) {
    return `Opening GitHub.\n[SPAWN: https://github.com | GitHub | üêô]`;
  }
  if (t.includes('http')) {
    const urlMatch = text.match(/https?:\/\/[^\s]+/);
    if (urlMatch) {
      const url = urlMatch[0];
      const title = new URL(url).hostname;
      return `Opening **${title}** in a research window.\n[SPAWN: ${url} | ${title} | üåê]`;
    }
  }
  return `I can open any URL or research topic in a floating window. Connect the backend for full web search and scraping.\n\nTry: *"Open Wikipedia article on black holes"* or paste any URL directly in the bar above.`;
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let msgDivs = [];
function addMsg(role, text) {
  const feed = document.getElementById('blitz-feed');
  const t = new Date().toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'});
  const div = document.createElement('div');
  div.className = `b-msg ${role}`;
  const content = role === 'b' ? renderMD(text) : esc(text);
  div.innerHTML = `<div class="b-who">${role==='u'?'YOU':'BLITZ'}</div><div class="b-bubble">${content}</div><div class="b-ts">${t}</div>`;
  feed.appendChild(div);
  feed.scrollTop = feed.scrollHeight;
  return div;
}
function showTyping(){ const f=document.getElementById('blitz-feed'),e=document.createElement('div');e.className='b-typing';e.id='b-typing';e.innerHTML='<div class="tdot"></div><div class="tdot"></div><div class="tdot"></div>';f.appendChild(e);f.scrollTop=f.scrollHeight; }
function hideTyping(){ document.getElementById('b-typing')?.remove(); }
function renderMD(t){let s=t.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');s=s.replace(/```(\w*)\n?([\s\S]*?)```/g,(_,l,c)=>`<pre>${c.trim()}</pre>`);s=s.replace(/`([^`]+)`/g,'<code>$1</code>');s=s.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');s=s.replace(/\*([^*]+)\*/g,'<em>$1</em>');s=s.replace(/^#{1,3} (.+)$/gm,'<strong style="display:block;margin:5px 0 2px">$1</strong>');s=s.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/g,'<a href="$2" target="_blank">$1</a>');s=s.replace(/\n/g,'<br>');return s;}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');}
function toast(msg,n=false){const t=document.getElementById('toast');t.textContent=msg;t.className='toast show'+(n?' nexus':'');clearTimeout(toastTimer);toastTimer=setTimeout(()=>t.classList.remove('show'),2200);}
function toggleBlitz(){document.getElementById('blitz-panel').classList.toggle('collapsed');}

document.getElementById('b-inp').addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); sendNexus(); } });

// Boot
setTimeout(()=>{
  addMsg('b','**B.L.I.T.Z. Nexus** online.\n\nI can spawn floating research windows for any URL or topic. Sites that block iframes are automatically scraped and displayed as formatted text.\n\n**Try:**\n- *"Open Wikipedia article on quantum computing"*\n- *"Research the Higgs boson discovery"*\n- Paste any URL in the bar above\n\nMultiple windows can be open simultaneously ‚Äî tile them with the ‚¨° Tile button.');
}, 500);
</script>
</body>
</html>